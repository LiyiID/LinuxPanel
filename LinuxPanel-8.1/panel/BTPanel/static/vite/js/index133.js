import{Q as e,bI as t,n as l,q as s}from"./main.js?v=1714377894636";import{_ as o}from"./index76.js?v=1714377894636";import{e as n,b as a,v as r,f as i,l as u,h as c,i as d,I as m,j as f}from"./vue-lib.js?v=1714377894636";import{x as p,a as v,b as w,c as x}from"./xterm-lib.js?v=1714377894636";import{X as y,x as h}from"./xterm.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";const _=l(n({__name:"index",props:{url:{default:"/ws_model"},id:{default:""},active:{type:Boolean,default:!0},hostInfo:{default:()=>({model_index:"btdocker",mod_name:"compose",def_name:"get_pull_log",ws_callback:111})},destroy:{type:Boolean,default:!0},immediately:{type:Boolean,default:!1},reConnect:{type:Function,default:()=>{}},notInit:{type:Boolean,default:!1}},emits:["close","complete"],setup(l,{expose:s,emit:o}){const n=l,{proxy:_}=f(),A=a(),k=a("success"),b=a(!1),g=a(!1),C=a(),T=r({isEditHostView:!0,isLocal:!0,rowsData:{host:"127.0.0.1",port:22,username:"root",password:"",pkey:"",pkey_passwd:"",ps:""}});let S,D,j=null;i((()=>g.value),(e=>{e&&u((()=>{var e;return null==(e=C.value)?void 0:e.onOpen()}))})),i((()=>j),(e=>{}));const B=()=>{j=e({route:n.url,onMessage:L})};let H=!0,I=0;const L=(e,t)=>{try{!0===H&&(H=!1);const e=t.data;if(e.includes("bt_successful")&&(_.$message.success("拉取成功"),null==j||j.close(),o("complete")),e.includes("bt_failed")&&(_.$message.error("拉取失败"),null==j||j.close(),o("complete")),e.includes("bt_successful")&&o("close"),e.indexOf("Authentication timeout.")>-1&&(b.value=!0),(-1!=e.indexOf("@127.0.0.1:")||-1!=e.indexOf("@localhost:"))&&-1!=e.indexOf("Authentication failed"))return null==j||j.close(),j=null,W(),k.value="danger",g.value=!0,!1;if("\r\n登出\r\n"==e||"登出\r\n"==e||"\r\nlogout\r\n"==e||"logout\r\n"==e||e.search(/logout[\r\n]+$/)>-1)return null==j||j.close(),j=null,W(),setTimeout((()=>{S.write("\r连接已断开,按回车将尝试重新连接!\r")}),500),k.value="danger",!1;if("warning"===k.value?setTimeout((()=>{k.value="success"}),500):k.value="success",!n.active&&I>3&&(k.value="warning"),n.active)return I=0,!1;setTimeout((()=>{I+=1}),500)}catch(l){}},O=()=>{S=new p.Terminal({cursorBlink:!0,fontSize:12,fontFamily:"Monaco, Menlo, Consolas, 'Courier New', monospace",theme:{background:"#333",foreground:"#ececec"}}),D=new v.FitAddon,F(),q(),n.immediately&&X(),D.fit()},F=()=>{j&&j.socket.ws.value&&(S.loadAddon(D),S.loadAddon(new h.CanvasAddon),S.loadAddon(new w.WebLinksAddon),S.loadAddon(new x.AttachAddon(j.socket.ws.value)))};let M=!1;const V=()=>{M=!0},W=()=>{M=!1},X=(e,l)=>{let s={...n.hostInfo};(null==e?void 0:e.reconnect)&&(null==j||j.send({id:t(6),host:e.host,port:e.port,ps:e.ps,sort:0})),null==j||j.send(s),"/webssh"===n.url&&(null==j||j.send("\r\n")),l&&n.reConnect(j),S.focus(),S.onData((e=>{"\r"===e&&b.value&&(b.value=!1,S.write("\r\n"),$()),null!==j||"\r"!==e||M||(k.value="danger",V(),S.write("\r\n正在尝试重新连接!\r\n"),$())}))},$=e=>{B();if(X({...e||{},reconnect:!0},!0),!j)return;const t=j.socket.ws.value;t&&S.loadAddon(new x.AttachAddon(t))},q=()=>{j&&S.open(A.value)},E=()=>{null==j||j.close(),j=null,n.destroy||S.dispose()},N=()=>{try{B();const e=null==j?void 0:j.socket.ws.value;e&&(null==S||S.clear(),S.loadAddon(new x.AttachAddon(e)))}catch(e){}},z=()=>{try{B(),O()}catch(e){}};return c((()=>{u((()=>{z()}))})),d((()=>{if(n.destroy)try{null==j||j.close(),j=null,S.dispose()}catch(e){}})),m((()=>{var e;const t=document.querySelector('div[style*="position: absolute; top: -50000px;"]');t&&(null==(e=t.parentNode)||e.removeChild(t))})),s({useSocket:()=>j,useTerminal:()=>S,useStatus:()=>k,init:z,socketSend:X,useDestroy:E,refreshTerminal:N}),{__sfc:!0,props:n,vm:_,emit:o,terminalDom:A,isStatus:k,isEnter:b,isLocalVerify:g,xtermAddHost:C,loacalDefault:T,useSocket:j,xterm:S,fitAddon:D,createWebSocket:B,first:H,lastsTime:I,onWSReceive:L,createTerminal:O,loadTerminal:F,lock:M,locked:V,unLock:W,socketSend:X,reconnectTerminal:$,openTerminal:q,saveConfig:async()=>{var e;(await(null==(e=C.value)?void 0:e.onConfirm())).status&&(g.value=!1,S.focus(),S.write("\r\n"))},useDestroy:E,refreshTerminal:N,init:z,XtermAddHost:y}}}),(function(){var e=this,t=e._self._c,l=e._self._setupProxy;return t("div",{staticClass:"flex relative w-full h-full"},[t("div",{ref:"terminalDom",staticClass:"w-full h-full"}),l.isLocalVerify?t("div",{staticClass:"terminal-add-host"},[t("div",{staticClass:"w-[50rem] bg-white rounded-4x flex flex-col items-center"},[t("div",{staticClass:"text-[1.8rem] pt-[2rem] pb-10x flex items-center w-full px-20x"},[t(o,{attrs:{type:"warning",closable:!1},scopedSlots:e._u([{key:"title",fn:function(){return[t("span",[e._v("无法自动认证，请填写本地服务器的登录信息!")])]},proxy:!0}],null,!1,3540643488)})],1),t(l.XtermAddHost,{ref:"xtermAddHost",attrs:{"comp-data":l.loacalDefault},on:{success:l.reconnectTerminal}}),t("div",{staticClass:"flex w-full mb-40x pl-[12rem]"},[t(s,{on:{click:l.saveConfig}},[e._v("保存配置")])],1)],1)]):e._e()])}),[],!1,null,null,null,null).exports;export{_};
