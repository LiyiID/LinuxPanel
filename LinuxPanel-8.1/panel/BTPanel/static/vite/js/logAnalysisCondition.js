import{g as e,c1 as r,n as t,D as s,a as o}from"./main.js?v=1714377894636";import{_ as a}from"./index40.js?v=1714377894636";import{w as l,x as i,B as n,E as u,o as m,v as c,A as p}from"./element-lib.js?v=1714377894636";import{_ as d}from"./index41.js?v=1714377894636";import{_}from"./index85.js?v=1714377894636";import{_ as g}from"./index117.js?v=1714377894636";import{e as f,b as y,w as v,f as h,h as F,j}from"./vue-lib.js?v=1714377894636";import{g as k,r as x,t as b,q as C,u as w}from"./ftp.store.js?v=1714377894636";import{b as $}from"./index27.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./config.js?v=1714377894636";import"./radio-button.js?v=1714377894636";import"./index52.js?v=1714377894636";import"./index53.js?v=1714377894636";import"./index39.js?v=1714377894636";import"./index54.js?v=1714377894636";import"./index56.js?v=1714377894636";import"./confirm.js?v=1714377894636";import"./index57.js?v=1714377894636";import"./index48.js?v=1714377894636";import"./index45.js?v=1714377894636";import"./index58.js?v=1714377894636";import"./index59.js?v=1714377894636";import"./index60.js?v=1714377894636";import"./index38.js?v=1714377894636";import"./check.js?v=1714377894636";import"./index76.js?v=1714377894636";import"./index77.js?v=1714377894636";import"./index42.js?v=1714377894636";const L=t(f({__name:"logAnalysisCondition",props:{compData:{default:()=>{}}},setup(t,{expose:s}){const o=t,{refs:{ftpAnalysisList:a}}=k(),{refs:{getPushConfigInfo:l}}=e(),{type:i,form:n}=o.compData,{proxy:u}=j(),{loading:m,close:c}=r(u),p=y(!1),d=y(!1),_=y(i),g=y([]),f=y([{title:"7天",value:7},{title:"30天",value:30},{title:"自定义",value:"other"}]),L=y([{title:"全部",key:"all"},{title:"指定用户",key:"other"}]),D={otherDay:[{validator:(e,r,t)=>{"other"===n.day&&r<1?t(new Error("天数必须大于0")):t()},trigger:["change"]}],userList:[{validator:(e,r,t)=>{"other"===n.user&&0===r.length?t("请选择指定用户"):t()},trigger:["change"]}],risk:[{validator:(e,r,t)=>{n.login_error||n.time||n.area||n.anonymous||n.upload_shell?t():t("请至少选择一个安全风险")},trigger:["change"]}],cycle:[{required:!0,message:"请输入周期",trigger:"blur"},{validator:(e,r,t)=>{let s=Number(r);""===r?t(new Error("周期不能为空")):s<1?t(new Error("周期必须大于0")):t()},trigger:["input"]}],value:[{type:"array",required:!0,message:"请至少选择一个告警方式",trigger:"change"}]},A=async()=>{d.value=!0;try{const{data:e}=await x();d.value=!1;const{area:r,cron_task_status:t}=e;n.config={...e,login_error_des:"超过"+e.login_error+"次",time_des:e.time.start_time+"点至"+e.time.end_time+"点范围外",area_des:"非"+(r.country.length?r.country.join(","):"")+(r.city.length?",":"")+r.city.join(",")+"地区",upload_shell_des:e.upload_shell.join(",")},_.value?t&&(n.anonymous=e.cron_task.task_type.anonymous,n.area=e.cron_task.task_type.area,n.login_error=e.cron_task.task_type.login_error,n.time=e.cron_task.task_type.time,n.upload_shell=e.cron_task.task_type.upload_shell,n.cycle=e.cron_task.cycle,n.value=e.cron_task.channel.split(","),n.status=!!e.cron_task_status):(n.anonymous=!0,n.area=!0,n.login_error=!0,n.time=!0,n.upload_shell=!0)}catch(e){}},S=async()=>{try{const{data:e}=await b();e.forEach((e=>{g.value.push({title:e,key:e})})),n.userList=e.length>0?[e[0]]:[]}catch(e){}},O=async()=>(u.$refs.addFtpInfo.validate((async(e,r)=>{if(e){const e=m(p,"扫描中...");try{const e=JSON.stringify({anonymous:n.anonymous,area:n.area,login_error:n.login_error,time:n.time,upload_shell:n.upload_shell});if(n.search=e,_.value){const r=await w({task_type:e,cycle:n.cycle,channel:n.value.join(","),status:n.status?1:0});u.$message.request(r),r.status&&A(),c()}else{const r=await C({search:e,day:"other"===n.day?Number(n.otherDay):n.day,username:"all"===n.user?"[]":JSON.stringify(n.userList)});if(u.$message.request({status:r.status,msg:r.status?"扫描成功":"扫描失败",time:500}),r.status){a.value.data=[];for(const e in r.data){const t=r.data[e];a.value.data.push({time:t.exec_time,type:t.type,user:t.user,ip:e,id:t.id}),a.value.data.sort(((e,r)=>new Date(r.time.replace(/-/g,"/")).getTime()-new Date(e.time.replace(/-/g,"/")).getTime()))}a.value.btn="重新扫描",a.value.scanStatus=!0,c()}}}catch(t){}finally{e.close()}}})),!1);return v((()=>{_.value=i})),h((()=>o.compData.config),(e=>{n.value=[],n.config={login_error:5,time:{start_time:0,end_time:24},area:{country:[],city:[]},upload_shell:[],login_error_des:"超过5次",time_des:"0点至24点范围外",area_des:"非地区",upload_shell_des:"未配置"}}),{immediate:!0}),F((async()=>{S(),A()})),s({onConfirm:O}),{__sfc:!0,props:o,ftpAnalysisList:a,getPushConfigInfo:l,autoScan:i,ruleForm:n,vm:u,loading:m,close:c,formDisabled:p,isLoading:d,isAutoScan:_,userOptions:g,scanWeekOption:f,userOption:L,rules:D,getFtpLogAnalysisConfig:A,setScanPrompt:()=>{$({analysisConfig:A,scanCondition:n.config})},userChange:e=>{n.user=e,"other"===e&&(n.anonymous=!1)},userListChange:e=>{n.userList=e},getAllFtpUser:S,onConfirm:O}}}),(function(){var e=this,r=e._self._c,t=e._self._setupProxy;return r("div",{staticClass:"px-[2rem] py-[2.4rem]"},[r(l,{directives:[{name:"loading",rawName:"v-loading",value:t.isLoading,expression:"isLoading"}],ref:"addFtpInfo",staticClass:"bt-custom-form p-0",attrs:{model:t.ruleForm,"label-width":"4rem",disabled:t.formDisabled,rules:t.rules},nativeOn:{submit:function(e){e.preventDefault()}}},[t.isAutoScan?[r(i,{attrs:{label:"告警状态"}},[r(n,{attrs:{"active-color":"#20A53A","inactive-color":"#cdcdcd"},model:{value:t.ruleForm.status,callback:function(r){e.$set(t.ruleForm,"status",r)},expression:"ruleForm.status"}})],1)]:e._e(),r(i,{attrs:{label:e.$t("FtpContent.risk"),prop:"risk"}},[r("div",{staticClass:"condition-risk"},[r(s,{model:{value:t.ruleForm.login_error,callback:function(r){e.$set(t.ruleForm,"login_error",r)},expression:"ruleForm.login_error"}},[r("span",[e._v("多次登录失败")]),r(u,{staticClass:"risk-tag",attrs:{type:"info",title:t.ruleForm.config.login_error_des}},[e._v(e._s(t.ruleForm.config.login_error_des))])],1),r(s,{model:{value:t.ruleForm.time,callback:function(r){e.$set(t.ruleForm,"time",r)},expression:"ruleForm.time"}},[r("span",[e._v("登录时间异常")]),r(u,{staticClass:"risk-tag",attrs:{type:"info",title:t.ruleForm.config.time_des}},[e._v(e._s(t.ruleForm.config.time_des))])],1),r(s,{model:{value:t.ruleForm.area,callback:function(r){e.$set(t.ruleForm,"area",r)},expression:"ruleForm.area"}},[r("span",[e._v("登录地区异常")]),r(u,{staticClass:"risk-tag",attrs:{type:"info",title:t.ruleForm.config.area_des}},[e._v(" "+e._s(t.ruleForm.config.area.country.length?t.ruleForm.config.area_des:"未配置")+" ")])],1),r(s,{attrs:{disabled:"other"===t.ruleForm.user&&!t.isAutoScan},model:{value:t.ruleForm.anonymous,callback:function(r){e.$set(t.ruleForm,"anonymous",r)},expression:"ruleForm.anonymous"}},[r("span",[e._v("匿名用户登录")])]),r(s,{model:{value:t.ruleForm.upload_shell,callback:function(r){e.$set(t.ruleForm,"upload_shell",r)},expression:"ruleForm.upload_shell"}},[r("span",[e._v("上传脚本文件")]),r(u,{staticClass:"risk-tag",attrs:{type:"info",title:t.ruleForm.config.upload_shell_des}},[e._v(" "+e._s(t.ruleForm.config.upload_shell.length?t.ruleForm.config.upload_shell_des:"未配置")+" ")])],1),r("div",[r(o,{on:{click:t.setScanPrompt}},[e._v("【设置扫描触发条件】")])],1)],1)]),t.isAutoScan?[r(i,{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],attrs:{label:"周期",prop:"cycle"}},[r(m,{staticClass:"max-w-[16rem]",attrs:{min:1,type:"number"},scopedSlots:e._u([{key:"append",fn:function(){return[r(c,{attrs:{type:"flex"}},[r(p,[r("span",[e._v("天")])])],1)]},proxy:!0}]),model:{value:t.ruleForm.cycle,callback:function(r){e.$set(t.ruleForm,"cycle",r)},expression:"ruleForm.cycle"}})],1),r(i,{attrs:{label:"告警方式",prop:"value"}},[r(a,{model:{value:t.ruleForm.value,callback:function(r){e.$set(t.ruleForm,"value",r)},expression:"ruleForm.value"}})],1)]:[r(i,{attrs:{label:e.$t("FtpContent.scanWeek"),prop:"otherDay"}},[r(g,{attrs:{type:"button",size:"small",options:t.scanWeekOption},model:{value:t.ruleForm.day,callback:function(r){e.$set(t.ruleForm,"day",r)},expression:"ruleForm.day"}}),"other"===t.ruleForm.day?r(_,{staticClass:"!inline-block ml-[1rem]",attrs:{type:"number"},model:{value:t.ruleForm.otherDay,callback:function(r){e.$set(t.ruleForm,"otherDay",r)},expression:"ruleForm.otherDay"}}):e._e()],1),r(i,{attrs:{label:e.$t("FtpContent.ftpUser"),prop:"userList"}},[r(d,{attrs:{options:t.userOption,change:t.userChange},model:{value:t.ruleForm.user,callback:function(r){e.$set(t.ruleForm,"user",r)},expression:"ruleForm.user"}}),"other"===t.ruleForm.user?r(d,{staticClass:"ml-[1rem]",attrs:{multiple:"","collapse-tags":"",filterable:"",options:t.userOptions,change:t.userListChange},model:{value:t.ruleForm.userList,callback:function(r){e.$set(t.ruleForm,"userList",r)},expression:"ruleForm.userList"}}):e._e()],1)]],2),r("div",{staticClass:"tip"},[r("ul",[t.isAutoScan?[r("li",[e._v(" 点击配置后状态未更新，尝试点击【 "),r(o,{on:{click:t.getPushConfigInfo}},[e._v("手动刷新")]),e._v(" 】 ")],1),r("li",[e._v("默认扫描全部用户30天的日志")])]:e._e(),r("li",[e._v("【多次登录失败】检测时间为：5分钟")])],2)])],1)}),[],!1,null,"f79237cf",null,null).exports;export{L as default};
