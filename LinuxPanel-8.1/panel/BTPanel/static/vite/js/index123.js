import{g as t,a2 as s,l as a,p as e,n as i,q as o,F as n,a as r}from"./main.js?v=1714377894636";import{_ as p}from"./index60.js?v=1714377894636";import{_ as l}from"./index118.js?v=1714377894636";import{_ as c}from"./index76.js?v=1714377894636";import{B as m}from"./element-lib.js?v=1714377894636";import{_ as d}from"./index85.js?v=1714377894636";import{_ as h}from"./index41.js?v=1714377894636";import{_ as u}from"./preload-helper.js?v=1714377894636";import{e as v,b as P,v as f,h as x,j as g}from"./vue-lib.js?v=1714377894636";import{g as w,ct as y,cu as _,cv as D,cw as T,cx as b,cy as C,cz as V,cA as H,cB as I,cC as j,cD as k}from"./site.store.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import{o as $}from"./software2.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./check.js?v=1714377894636";const S=i(v({__name:"index",props:{compData:{default:()=>({})}},setup(i){const o=i,{proxy:n}=g(),{getPhpModulesList:r}=w(),{refs:{authType:p}}=t(),l=P(null),c=f({phpVersion:"",other:"",options:[],helpIndex:0,toggleShow:!1,noInstall:!1}),m=f({status:!1}),d=f({status:!1,version:"",deCompatible:!1,today:0,total:0,tips:!0,tipsIndex:0,safeTip:{show:!1,alarmTip:!1,safeTip:!1,allTip:!1}}),h=f({list:[],path:""}),v=P(!1),S=t=>{switch(t){case"other":c.helpIndex=1;break;case"52":c.helpIndex=3;break;default:"7"===t[0]?c.helpIndex=2:c.helpIndex=0}},N=async t=>{d.tips=!0,d.version=t;if(d.tips=["52","00","82"].includes(t),d.tips)return void(d.tipsIndex=0);const{data:a}=await s({sName:"security_notice"});d.tips=!0,!(null==a?void 0:a.setup)&&a.endtime>=0?d.tipsIndex=1:a.endtime<0?d.tipsIndex=2:(d.tips=!1,await E())},L=async()=>{const t=await C({siteName:o.compData.name});t.status&&(c.phpVersion=t.data.phpversion,N(t.data.phpversion))},q=async t=>{const s=await V({s_type:!0===t?1:0});if(s.status&&s.data.length>0){const t=s.data.map((t=>({title:t.name,key:t.version})));c.options=t;c.options.find((t=>t.key===c.phpVersion))||(c.options.push({title:"PHP-".concat(c.phpVersion,"(未安装)"),key:c.phpVersion,noInstall:!0}),c.noInstall=!0)}},A=async()=>{const t=await H({id:o.compData.id});t.status&&(m.status=t.data)},E=async()=>{var t;try{const s=await I();if(!s.status){if(s.msg.includes("插件不存在")||s.msg.includes("未购买")||s.msg.includes("已到期"))return d.tips=!0,d.tipsIndex=1,"ltd"!==p.value&&(d.tipsIndex=2),!1;n.$message.error(s.msg)}const a=s.data.send,e=await j();e.status||n.$message.error(e.msg);const i=e.data.php_versions.filter((t=>t.v===d.version))||[],r=(null==i?void 0:i.length)>0&&1!==(null==(t=i[0])?void 0:t.state);!r&&a||(!a&&(d.safeTip.alarmTip=!0),r&&!a&&(d.safeTip.allTip=!0),r&&(d.safeTip.safeTip=!0),d.safeTip.show=!0),r||(d.safeTip.safeTip=!1,d.safeTip.allTip=!1),a&&(d.safeTip.alarmTip=!1,d.safeTip.allTip=!1),!r&&a&&(d.safeTip.show=!1);const l=await k();l.status||n.$message.error(l.msg);const c=l.data.sites.find((t=>t.path===o.compData.path&&t.site_name===o.compData.name));c&&(d.today=c.total.day_total||0,d.total=c.total.total||0,d.status=c.open,d.deCompatible=-1!=c.version.indexOf("暂不兼容"),O(c.config.file_info),h.path=c.path)}catch(s){}},O=t=>{const s=[];for(const a in t)Object.prototype.hasOwnProperty.call(t,a)&&s.push({...t[a],path:a});h.list=s},M=async()=>{v.value=!0;try{await L(),await q(!0),await A()}catch(t){}finally{v.value=!1}};return x((async()=>{await M()})),{__sfc:!0,vm:n,props:o,getPhpModulesList:r,authType:p,otherInput:l,versionData:c,sessionData:m,siteProtectData:d,monitorData:h,viewLoading:v,phpVersionHelp:[[{text:"请根据您的程序需求选择版本"}],[{text:"请根据您的程序需求选择版本"},{text:"【自定义】可自定义PHP连接信息，选择此项需填写可用的PHP连接配置"},{text:"【自定义】当前仅支持nginx，可配合[宝塔负载均衡 - 重构版]插件的TCP负载功能实现PHP负载集群"},{text:"【PHP连接配置】支持TCP或Unix配置，示例：192.168.1.25:9001 或 unix:/tmp/php8.sock"}],[{text:"请根据您的程序需求选择版本"},{text:"PHP7不支持mysql扩展，默认安装mysqli以及mysql-pdo。"}],[{text:"请根据您的程序需求选择版本"},{text:"若非必要,请尽量不要使用PHP5.2,这会降低您的服务器安全性；"}]],sessionHelp:[{text:"开启后将会把session文件存放到独立文件夹，不与其他站点公用存储位置"},{text:"若您在PHP配置中将session保存到memcache/redis等缓存器时，请不要开启此选项"}],siteProtectHelp:[{text:"基于PHP内核的监控工具，实时监控网站木马、漏洞等其他入侵行为，发现木马支持自动隔离"},{text:"安全告警默认会监视当前网站访问非当前网站文件的行为(例：你的站点A.com访问了站点B.com的文件或者目录)，通过添加监视器路径，当路径被访问时发送告警/redis等缓存器时，请不要开启此选项"}],eventSelect:t=>{c.phpVersion=t,c.toggleShow=t!==d.version,c.noInstall=c.options.some((s=>s.key===t&&(null==s?void 0:s.noInstall))),S(t)},isPhpVersion:S,setVersion:async()=>{if("other"===c.phpVersion&&""===c.other)return n.$message.error("自定义PHP版本时，PHP连接配置不能为空"),void l.value.$refs.inputRef.focus();const t=await y({siteName:o.compData.name,version:c.phpVersion,other:c.other});t.status?(n.$message.request(t),r(),c.toggleShow=!1):n.$message.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:t.msg||t,type:"error",duration:0,showClose:!0}),M()},setSession:async t=>{const s=t?1:0,a=await _({id:o.compData.id,act:s});n.$message.request(a),A()},isSiteProtect:N,setProtext:async t=>{try{if(d.safeTip.safeTip)return d.status=!d.status,void n.$message.error("请先开启PHP-".concat(d.version,"防护"));if(d.deCompatible)return d.status=!d.status,n.$message.error("当前版本不兼容安全防护功能");await n.$confirm({title:"".concat(t?"开启":"关闭","站点安全告警"),width:"35rem",icon:"warning",iconColor:"#E6A23C",message:t?"开启后，检测到安全问题时将会发送告警通知，是否继续？":"关闭后，该网站将不再接收安全告警，是否继续？"});const s=await D({siteName:o.compData.name},t);s.data.status?n.$message.request(s):(d.status=!d.status,n.$message.error("当前PHP版本未开启防护，无法设置该站点！"))}catch(s){d.status=!d.status}},monitor:()=>{a({area:93,isAsync:!0,title:"【".concat(o.compData.name,"】监视器"),component:()=>u((()=>import("./SafeMonitor.js?v=1714377894636")),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]),import.meta.url),compData:{data:h.list,name:o.compData.name,path:h.path}})},triggerLog:async()=>{const t=await T({siteName:o.compData.name,page:1,limit:10});t.status?0!=t.data.data.length?a({area:93,isAsync:!0,title:"【".concat(o.compData.name,"】网站安全日志"),component:()=>u((()=>import("./SafeLog.js?v=1714377894636")),__vite__mapDeps([26,27,3,10,2,9,4,5,6,7,8,11,12,16,24,17,18,15,19,20,21,22,23,25]),import.meta.url),compData:{data:t.data.data,page:t.data.page,name:o.compData.name,path:h.path}}):n.$message.error("暂无日志"):n.$message.error(t.msg)},setVersionProtect:async()=>{},openVersionProtect:async()=>{try{await n.$confirm({title:"开启【PHP-".concat(d.version,"】防护"),width:"35rem",icon:"warning",iconColor:"#E6A23C",message:"开启后，该版本下的所有站点将受到安全防护，是否继续？"});const t=await b({php_version:d.version,enable:1});n.$message.request(t),M()}catch(t){}},getPhpVersionData:L,getPhpVersionList:q,getSessionStatusData:A,getProtectData:E,monitorDataHandle:O,installVersion:async()=>{try{const t="php-".concat(c.phpVersion.split("")[0],".").concat(c.phpVersion.split("")[1]),{data:a}=await s({sName:t});await $({name:t,softData:a})}catch(t){}},openPlugin:async()=>{try{const{data:t}=await s({sName:"security_notice"});await $({name:"security_notice",softData:t})}catch(t){}},openPayView:()=>{e({sourceId:114})},init:M}}}),(function(){var t=this,s=t._self._c,a=t._self._setupProxy;return s("div",{directives:[{name:"loading",rawName:"v-loading",value:a.viewLoading,expression:"viewLoading"}]},[s("div",{staticClass:"border-b border-dashed border-[#ccc] mb-[2.2rem] pb-[2.2rem]"},[s("div",{staticClass:"flex mb-20x"},[s("div",{staticClass:"title-span"},[t._v("PHP版本")]),s(h,{staticClass:"w-[14rem]",attrs:{options:a.versionData.options,change:a.eventSelect},model:{value:a.versionData.phpVersion,callback:function(s){t.$set(a.versionData,"phpVersion",s)},expression:"versionData.phpVersion"}}),s(d,{directives:[{name:"show",rawName:"v-show",value:"other"===a.versionData.phpVersion,expression:"versionData.phpVersion === 'other'"}],ref:"otherInput",staticClass:"!ml-12x",attrs:{width:"30rem",placeholder:"连接配置，如：1.1.1.1:9001或unix:/tmp/php.sock"},model:{value:a.versionData.other,callback:function(s){t.$set(a.versionData,"other",s)},expression:"versionData.other"}}),s(o,{directives:[{name:"show",rawName:"v-show",value:a.versionData.toggleShow,expression:"versionData.toggleShow"}],staticClass:"!ml-12x",on:{click:a.setVersion}},[t._v("切换")]),a.versionData.noInstall?s(o,{staticClass:"!ml-12x",on:{click:a.installVersion}},[t._v("安装")]):t._e()],1),s(l,{staticClass:"ml-20x mt-20x",attrs:{list:a.phpVersionHelp[a.versionData.helpIndex],"list-style":"disc"}})],1),s("div",{staticClass:"border-b border-dashed border-[#ccc] my-[2.2rem] pb-[2.2rem]"},[s("div",{staticClass:"flex mb-20x"},[s("div",{staticClass:"title-span"},[t._v("session隔离")]),s(m,{on:{change:a.setSession},model:{value:a.sessionData.status,callback:function(s){t.$set(a.sessionData,"status",s)},expression:"sessionData.status"}})],1),s(l,{staticClass:"ml-20x mt-20x",attrs:{list:a.sessionHelp,"list-style":"disc"}})],1),s("div",{staticClass:"my-[2.2rem] relative"},[s("div",{staticClass:"flex mb-20x items-center"},[s("div",{staticClass:"title-span"},[s(n,{staticClass:"mr-4x",attrs:{name:"icon-ltd",size:"1.6"}}),t._v("站点防护 ")],1),s(m,{on:{change:a.setProtext},model:{value:a.siteProtectData.status,callback:function(s){t.$set(a.siteProtectData,"status",s)},expression:"siteProtectData.status"}}),s("span",{staticClass:"ml-[2rem]"},[t._v("今日："+t._s(a.siteProtectData.today))]),s("span",{staticClass:"ml-[2rem]"},[t._v("总告警数："+t._s(a.siteProtectData.total))]),s("div",{directives:[{name:"show",rawName:"v-show",value:a.siteProtectData.safeTip.show,expression:"siteProtectData.safeTip.show"}],staticClass:"w-[37rem] ml-[2rem]"},[s(c,{attrs:{type:"warning",closable:!1},scopedSlots:t._u([{key:"title",fn:function(){return[s("span",[t._v("未启用PHP安全告警，请先")]),s(r,{directives:[{name:"show",rawName:"v-show",value:a.siteProtectData.safeTip.alarmTip,expression:"siteProtectData.safeTip.alarmTip"}],attrs:{type:"danger"},on:{click:a.setVersionProtect}},[t._v("设置告警")]),s("span",{directives:[{name:"show",rawName:"v-show",value:a.siteProtectData.safeTip.allTip,expression:"siteProtectData.safeTip.allTip"}]},[t._v("和")]),s(r,{directives:[{name:"show",rawName:"v-show",value:a.siteProtectData.safeTip.safeTip,expression:"siteProtectData.safeTip.safeTip"}],attrs:{type:"danger"},on:{click:a.openVersionProtect}},[t._v("开启PHP-"+t._s(a.siteProtectData.version)+"防护")])]},proxy:!0}])})],1)],1),s("div",{staticClass:"flex mb-20x"},[s(o,{attrs:{type:"default"},on:{click:a.monitor}},[t._v("监视器")]),s(o,{staticClass:"!ml-12x",attrs:{type:"default"},on:{click:a.triggerLog}},[t._v("触发日志")])],1),s(l,{staticClass:"ml-20x mt-20x",attrs:{list:a.siteProtectHelp,"list-style":"disc"}}),s(p,{attrs:{visible:a.siteProtectData.tips,width:"36rem"}},[s("div",{staticClass:"text-[1.2rem] ml-12x"},[0===a.siteProtectData.tipsIndex?s("span",[t._v("当前PHP版本不兼容此功能,请切换其他PHP版本")]):t._e(),1===a.siteProtectData.tipsIndex?s("span",[t._v("当前未安装【PHP网站安全告警】, "),s(r,{on:{click:a.openPlugin}},[t._v("点击安装")])],1):t._e(),2===a.siteProtectData.tipsIndex?s("span",[t._v("当前未购买【PHP网站安全告警】, "),s(r,{on:{click:a.openPayView}},[t._v("点击购买")])],1):t._e()])])],1)])}),[],!1,null,"97754430",null,null).exports;export{S as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["./SafeMonitor.js?v=1714377894636","./index118.js?v=1714377894636","./vue-lib.js?v=1714377894636","./__commonjsHelpers__.js?v=1714377894636","./main.js?v=1714377894636","./modulepreload-polyfill.js?v=1714377894636","./preload-helper.js?v=1714377894636","./request-lib.js?v=1714377894636","./locales-lib.js?v=1714377894636","./public-lib.js?v=1714377894636","./element-lib.js?v=1714377894636","./index39.js?v=1714377894636","./element-lib.js?v=1714377894636","./index58.js?v=1714377894636","./element-lib.js?v=1714377894636","./index45.js?v=1714377894636","./index59.js?v=1714377894636","./site.popup.js?v=1714377894636","./index38.js?v=1714377894636","./element-ui.common.js?v=1714377894636","./date-util.js?v=1714377894636","./vdom.js?v=1714377894636","./index62.js?v=1714377894636","./cascader-panel.js?v=1714377894636","./check.js?v=1714377894636","./site.store.js?v=1714377894636","./SafeLog.js?v=1714377894636","./index52.js?v=1714377894636"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
