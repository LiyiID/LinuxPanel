import{o as e,aS as t,n as o,D as a,a as s,r,q as n}from"./main.js?v=1714377894636";import{w as l,x as d,q as i,s as c,j as p}from"./element-lib.js?v=1714377894636";import{_ as m}from"./index85.js?v=1714377894636";import{e as _,b as u,h as v,j as w}from"./vue-lib.js?v=1714377894636";import{o as f}from"./software2.js?v=1714377894636";import{g as j,b8 as b,b6 as g,b9 as x,i as A,b4 as F,b5 as h,B as y}from"./site.store.js?v=1714377894636";import{c as k}from"./check.js?v=1714377894636";import{o as C}from"./confirm.js?v=1714377894636";import{r as D}from"./site.rules.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./config.js?v=1714377894636";const $=o(_({__name:"AddSitePopup",props:{compData:{default:{rowData:{},isEdit:!1}}},setup(o,{expose:a}){const s=o,{getModulesList:r}=j(),{proxy:n}=w(),l=u(!1),d=u(),i=u(!1),c=u({project_cwd:"/www/wwwroot",project_name:"",port:"",project_script:"",run_user:"www",project_ps:"",domains:"",release_firewall:!1,pkg_manager:"yarn",nodejs_version:"",not_install_pkg:!1,bind_extranet:!1,is_power_on:0,max_memory_limit:4096,project_env:""}),p=u(""),m=u([]),_=u([]),$=async()=>{try{const e=await b();m.value=e.data,c.value.nodejs_version=e.data[0]}catch(e){}},E=async()=>{var e;try{const t=await x({data:JSON.stringify({project_cwd:c.value.project_cwd})}),o=k(t.data,"object",{});if(0===Object.keys(o).length)c.value.project_script="0",s.compData.isEdit&&(p.value=null==(e=s.compData.rowData)?void 0:e.project_config.project_script);else{let e=Object.keys(o);_.value=[],e.forEach((e=>{_.value.push({label:e+":"+o[e],value:e})})),c.value.project_script=e[0]||""}}catch(t){}},N=async()=>{try{const{data:e}=await A({sName:"nodejs"});await f({name:"nodejs",softData:e})}catch(e){}},O=async e=>{let t=Object.assign({},c.value);if(""!==t.domains){t.bind_extranet=1;const e=k(t.domains,"string","");t.domains=e.split("\n"),""===e&&delete t.domains}else t.bind_extranet=0,delete t.domains;if("0"===t.project_script&&(t.project_script=p.value),"0"===t.project_script&&!p.value)return n.$message.error("请输入自定义启动命令");t.is_power_on=t.is_power_on?1:0,C({$refs:d.value,loading:{disable:l},request:async()=>{let o;return o=s.compData.isEdit?await F({data:JSON.stringify(t)},"nodejs"):await h({data:JSON.stringify(t)},"nodejs"),o.data.status?(n.$message.success(o.data.data),e()):n.$message.error(o.data.error_msg),r("nodejs"),null}})},L=async()=>{var e;try{let t=(await y({data:JSON.stringify({project_name:null==(e=s.compData)?void 0:e.rowData.name})},"nodejs")).data;t.isEdit=!0,c.value={...null==t?void 0:t.project_config,project_ps:null==t?void 0:t.ps,is_power_on:!!(null==t?void 0:t.project_config.is_power_on),not_install_pkg:!!(null==t?void 0:t.project_config.not_install_pkg),project_cwd:null==t?void 0:t.project_config.project_cwd}}catch(t){}};return v((async()=>{var e;i.value=!0,await $(),m.value.length?s.compData.isEdit&&(await L(),await E()):(n.$root.close(),N()),i.value=!1;const t=JSON.parse(null!=(e=sessionStorage.getItem("BT-CONFIG"))?e:"{}").sites_path;t&&!s.compData.isEdit&&(c.value.project_cwd=t)})),a({onConfirm:O}),{__sfc:!0,props:s,getModulesList:r,vm:n,formDisabled:l,nodeAddFormRef:d,formLoading:i,nodeAddForm:c,userCmd:p,nodeVersionList:m,runList:_,getNodejsVersionEvent:$,checkPortUse:async()=>{if(c.value.port)try{const e=await g({port:c.value.port},"nodejs");e.status||(n.$message.request(e),c.value.port="")}catch(e){}},getRunListEvent:E,openNodeVersion:N,onPathChange:()=>{t({type:"dir",path:c.value.project_cwd,change:e=>{var t;if(c.value.project_cwd=e,!s.compData.isEdit&&e){let o=null==(t=null==e?void 0:e.substring(e.lastIndexOf("/")+1))?void 0:t.replace(/\./g,"_");c.value.project_name=o,c.value.project_ps=o,E()}}})},onSelectCmd:()=>{t({type:"file",path:p.value,change:e=>{p.value=e}})},onConfirm:O,getInfo:L,isRelease:e,rules:D}}}),(function(){var e,t,o,_=this,u=_._self._c,v=_._self._setupProxy;return u("div",{staticClass:"p-20x"},[u(l,{directives:[{name:"loading",rawName:"v-loading",value:v.formLoading,expression:"formLoading"}],ref:"nodeAddFormRef",attrs:{model:v.nodeAddForm,"label-width":"100px",rules:v.rules,disabled:v.formDisabled}},[u(d,{attrs:{label:"项目目录",prop:"project_cwd"}},[u(m,{attrs:{width:"32rem","icon-type":"folder",readOnly:""},on:{folder:v.onPathChange},model:{value:v.nodeAddForm.project_cwd,callback:function(e){_.$set(v.nodeAddForm,"project_cwd",e)},expression:"nodeAddForm.project_cwd"}})],1),u(d,{attrs:{label:"项目名称",prop:"project_name"}},[u(m,{attrs:{disabled:_.compData.isEdit,width:"32rem",placeholder:"请输入node项目名称"},model:{value:v.nodeAddForm.project_name,callback:function(e){_.$set(v.nodeAddForm,"project_name",e)},expression:"nodeAddForm.project_name"}})],1),u(d,{attrs:{label:"启动选项",prop:"project_script"}},[u("div",{staticClass:"flex items-center"},[u(i,{staticClass:"w-[20rem]",attrs:{placeholder:"请选择项目目录进行操作",disabled:"/www/wwwroot/"===v.nodeAddForm.project_cwd||"/www/wwwroot"===v.nodeAddForm.project_cwd},model:{value:v.nodeAddForm.project_script,callback:function(e){_.$set(v.nodeAddForm,"project_script",e)},expression:"nodeAddForm.project_script"}},[u(c,{attrs:{label:"自定义启动命令",value:"0"}}),_._l(v.runList,(function(e){return u(c,{key:e.value,attrs:{label:e.label,value:e.value}})}))],2),u("span",{staticClass:"ml-8x"},[_._v("* 自动获取package.json文件中的启动模式")])],1)]),"0"===v.nodeAddForm.project_script?u(d,{attrs:{label:" "}},[u(m,{attrs:{placeholder:"请输入自定义启动命令","icon-type":"folder",width:"32rem"},on:{folder:v.onSelectCmd},model:{value:v.userCmd,callback:function(e){v.userCmd=e},expression:"userCmd"}})],1):_._e(),u(d,{attrs:{label:"项目端口",prop:"port"}},[u("div",{staticClass:"flex items-center"},[u(m,{staticClass:"mr-12x",attrs:{width:"20rem",type:"number",placeholder:"请输入项目真实端口"},on:{blur:v.checkPortUse},model:{value:v.nodeAddForm.port,callback:function(e){_.$set(v.nodeAddForm,"port",e)},expression:"nodeAddForm.port"}}),_.compData.isEdit?_._e():u(a,{model:{value:v.nodeAddForm.release_firewall,callback:function(e){_.$set(v.nodeAddForm,"release_firewall",e)},expression:"nodeAddForm.release_firewall"}},[_._v(" 放行端口 "),u(p,{staticClass:"item",attrs:{effect:"dark",content:"选中将在防火墙安全组放行监听端口，放行后该项目可在外网访问",placement:"right"}},[u("i",{staticClass:"el-icon-question text-warning"})])],1)],1),_.compData.isEdit&&!(null==(e=_.compData.rowData)?void 0:e.listen.includes(v.nodeAddForm.port))&&(null==(t=_.compData.rowData)?void 0:t.listen.length)?u("span",{staticClass:"text-danger text-[1.2rem]"},[_._v(" 项目端口可能有误，检测到当前项目监听了以下端口[ "+_._s(null==(o=_.compData.rowData)?void 0:o.listen.join(","))+" ]")]):_._e()]),u(d,{attrs:{label:"运行用户"}},[u("div",{staticClass:"flex items-center"},[u(i,{staticClass:"mr-8x w-[16rem]",model:{value:v.nodeAddForm.run_user,callback:function(e){_.$set(v.nodeAddForm,"run_user",e)},expression:"nodeAddForm.run_user"}},[u(c,{attrs:{label:"www",value:"www"}}),u(c,{attrs:{label:"root",value:"root"}})],1),u("span",{staticClass:"text-[1.2rem] text-[#666]"},[_._v("* 无特殊需求请选择www用户")])],1)]),u(d,{attrs:{label:"包管理器"}},[u("div",{staticClass:"flex items-center"},[u(i,{staticClass:"w-[16rem]",model:{value:v.nodeAddForm.pkg_manager,callback:function(e){_.$set(v.nodeAddForm,"pkg_manager",e)},expression:"nodeAddForm.pkg_manager"}},[u(c,{attrs:{label:"yarn",value:"yarn"}}),u(c,{attrs:{label:"npm",value:"npm"}}),u(c,{attrs:{label:"pnpm",value:"pnpm"}})],1),u("span",{staticClass:"text-[1.2rem] text-[#666 mx-8x"},[_._v("* 请选择项目的包管理器")]),v.isRelease?_._e():u(a,{model:{value:v.nodeAddForm.not_install_pkg,callback:function(e){_.$set(v.nodeAddForm,"not_install_pkg",e)},expression:"nodeAddForm.not_install_pkg"}},[_._v(" 不安装node_module ")])],1)]),u(d,{attrs:{label:"Node版本"}},[u("div",{staticClass:"flex items-center"},[u(i,{staticClass:"mr-8x w-[16rem]",model:{value:v.nodeAddForm.nodejs_version,callback:function(e){_.$set(v.nodeAddForm,"nodejs_version",e)},expression:"nodeAddForm.nodejs_version"}},_._l(v.nodeVersionList,(function(e){return u(c,{key:e,attrs:{label:e,value:e}})})),1),u("span",{staticClass:"text-[1.2rem] text-[#666]"},[_._v("* 请根据项目选择合适的Node版本，")]),u(s,{on:{click:v.openNodeVersion}},[_._v("安装其他版本")])],1)]),u(d,{attrs:{label:"项目备注"}},[u(m,{attrs:{width:"32rem",placeholder:"输入项目备注，非必填"},model:{value:v.nodeAddForm.project_ps,callback:function(e){_.$set(v.nodeAddForm,"project_ps",e)},expression:"nodeAddForm.project_ps"}})],1),_.compData.isEdit?_._e():u(d,{attrs:{label:"绑定域名"}},[u(r,{ref:"popover",attrs:{placement:"top-start","popper-class":"green-tips-popover",title:"",width:"400",trigger:"focus"}},[u("div",{staticClass:"!p-12x bg-[#20a53a] text-white"},[_._v(" 如需填写多个域名，请换行填写，每行一个域名，默认为80端口"),u("br"),_._v(" IP地址格式：192.168.1.199"),u("br"),_._v(" 泛解析添加方法 *.domain.com"),u("br"),_._v(" 如另加端口格式为 www.domain.com:88 ")]),u(m,{directives:[{name:"popover",rawName:"v-popover:popover",arg:"popover"}],attrs:{slot:"reference",rows:6,resize:"none",width:"40rem",type:"textarea",placeholder:"如需填写多个域名，请换行填写，每行一个域名，默认为80端口\nIP地址格式：192.168.1.199\n泛解析添加方法 *.domain.com\n如另加端口格式为 www.domain.com:88"},slot:"reference",model:{value:v.nodeAddForm.domains,callback:function(e){_.$set(v.nodeAddForm,"domains",e)},expression:"nodeAddForm.domains"}})],1)],1),_.compData.isEdit?u(d,{attrs:{label:"开机启动"}},[u(a,{model:{value:v.nodeAddForm.is_power_on,callback:function(e){_.$set(v.nodeAddForm,"is_power_on",e)},expression:"nodeAddForm.is_power_on"}},[_._v("跟随系统服务启动")])],1):_._e(),_.compData.isEdit?u(d,{attrs:{label:" "}},[u(n,{on:{click:v.onConfirm}},[_._v("保存配置")])],1):_._e()],1),_._m(0)],1)}),[function(){var e=this,t=e._self._c;return e._self._setupProxy,t("ul",{staticClass:"mt-20x leading-8 text-[1.2rem] list-disc ml-20x"},[t("li",[e._v(" 【启动选项】：默认读取package.json中的scripts列表，也可以选择[自定义启动命令]选项来手动输入启动命令 ")]),t("li",[e._v(" 【自定义启动命令】：可以选择启动文件，或直接输入启动命令，支持的启动方式：例：npm/node/pm2/yarn ")]),t("li",[e._v(" 【项目端口】：错误的端口会导致访问502，若不知道端口，可先随意填写，启动项目后再改为正确端口 ")]),t("li",[e._v("【运行用户】：为了安全考虑，默认使用www用户运行，root用户运行可能带来安全风险")])])}],!1,null,"466b65ef",null,null).exports;export{$ as default};
