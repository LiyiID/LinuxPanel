import{Q as e,n as t,q as s}from"./main.js?v=1714377894636";import{_ as o}from"./index76.js?v=1714377894636";import{e as n,b as l,v as a,f as r,l as i,h as u,i as d,I as c,j as f,x as v,O as m}from"./vue-lib.js?v=1714377894636";import{x as p,a as w,b as x,c as h}from"./xterm-lib.js?v=1714377894636";import{X as _,x as k}from"./xterm.js?v=1714377894636";const A=t(n({__name:"index",props:{url:{default:"/webssh"},id:{default:""},active:{type:Boolean,default:!0},hostInfo:{default:()=>({})}},emits:["close"],setup(t,{expose:s,emit:o}){const n=t,{proxy:A}=f(),b=l(),y=l("success"),g=l(),C=l(!1),S=l(!1),T=l(),O=a({isEditHostView:!0,isLocal:!0,rowsData:{host:"127.0.0.1",port:22,username:"root",password:"",pkey:"",pkey_passwd:"",ps:""}});let D,j,L=null;r((()=>n.active),(e=>{e&&R()})),r((()=>S.value),(e=>{e&&i((()=>{var e;return null==(e=T.value)?void 0:e.onOpen()}))}));const H=()=>{L=e({route:n.url,onMessage:z,noInit:!0})};let I=!0,q=0;const z=(e,t)=>{!0===I&&(I=!1,P());const s=t.data;return s.indexOf("支持的身份验证类型"),s.indexOf("Authentication timeout.")>-1&&(C.value=!0),-1==s.indexOf("@127.0.0.1:")&&-1==s.indexOf("@localhost:")||-1==s.indexOf("Authentication failed")?"\r\n登出\r\n"==s||"登出\r\n"==s||"\r\nlogout\r\n"==s||"logout\r\n"==s||s.search(/logout[\r\n]+$/)>-1?(null==L||L.close(),L=null,X(),setTimeout((()=>{D.write("\r连接已断开,按回车将尝试重新连接!\r")}),500),y.value="danger",!1):("warning"===y.value?setTimeout((()=>{y.value="success"}),500):y.value="success",!n.active&&q>3&&(y.value="warning"),n.active?(q=0,!1):void setTimeout((()=>{q+=1}),500)):(null==L||L.close(),L=null,X(),y.value="danger",S.value=!0,!1)},E=()=>{D=new p.Terminal({cursorBlink:!0,fontSize:14,fontFamily:"Monaco, Menlo, Consolas, 'Courier New', monospace",theme:{background:"#111",foreground:"#fff"}}),j=new w.FitAddon,M(),N(),B(),R()},M=()=>{L&&L.socket.ws.value&&(D.loadAddon(j),D.loadAddon(new k.CanvasAddon),D.loadAddon(new x.WebLinksAddon),D.loadAddon(new h.AttachAddon(L.socket.ws.value)))};let V=!1;const W=()=>{V=!0},X=()=>{V=!1},B=()=>{let e={id:n.id,"x-http-token":window.vite_public_request_token,...n.hostInfo};"/pyenv_webssh"===n.url&&(e={...n.hostInfo},null==L||L.send({"x-http-token":window.vite_public_request_token})),null==L||L.send(e),D.focus(),D.onData((e=>{"\r"===e&&C.value&&(C.value=!1,D.write("\r\n"),F()),null!==L||"\r"!==e||V||(y.value="danger",W(),D.write("\r\n正在尝试重新连接!\r\n"),F())}))},F=()=>{if(H(),B(),!L)return;const e=L.socket.ws.value;e&&D.loadAddon(new h.AttachAddon(e))},N=()=>{L&&D.open(b.value)},R=()=>{if(L&&(j.fit(),!L.isStatus("CLOSED"))){const{cols:e,rows:t}=D;L.send({cols:e,rows:t,resize:1})}},P=()=>{g.value=v(b.value,m((()=>{R()}),200))};return u((()=>{i((()=>{H(),E()}))})),d((()=>{var e;try{null==L||L.close(),L=null,D.dispose(),g.value instanceof ResizeObserver&&(null==(e=g.value)||e.disconnect())}catch(t){}})),c((()=>{var e;const t=document.querySelector('div[style*="position: absolute; top: -50000px;"]');t&&(null==(e=t.parentNode)||e.removeChild(t))})),s({useSocket:()=>L,useTerminal:()=>D,useStatus:()=>y}),{__sfc:!0,vm:A,props:n,emit:o,terminalDom:b,isStatus:y,termObserver:g,isEnter:C,isLocalVerify:S,xtermAddHost:T,loacalDefault:O,useSocket:L,terminal:D,fitAddon:j,createWebSocket:H,first:I,lastsTime:q,onWSReceive:z,createTerminal:E,loadTerminal:M,lock:V,locked:W,unLock:X,socketSend:B,reconnectTerminal:F,openTerminal:N,fitTerminal:R,resizeTerminal:P,saveConfig:async()=>{var e;(await(null==(e=T.value)?void 0:e.onConfirm())).status&&(S.value=!1,D.focus(),D.write("\r\n"),F())},XtermAddHost:_}}}),(function(){var e=this,t=e._self._c,n=e._self._setupProxy;return t("div",{staticClass:"flex relative"},[t("div",{ref:"terminalDom",staticClass:"w-full h-full"}),n.isLocalVerify?t("div",{staticClass:"terminal-add-host"},[t("div",{staticClass:"w-[50rem] bg-white rounded-4x flex flex-col items-center"},[t("div",{staticClass:"text-[1.8rem] pt-[2rem] pb-10x flex items-center w-full px-20x"},[t(o,{attrs:{type:"warning",closable:!1},scopedSlots:e._u([{key:"title",fn:function(){return[t("span",[e._v("无法自动认证，请填写本地服务器的登录信息!")])]},proxy:!0}],null,!1,3540643488)})],1),t(n.XtermAddHost,{ref:"xtermAddHost",attrs:{"comp-data":n.loacalDefault}}),t("div",{staticClass:"flex w-full mb-40x pl-[12rem]"},[t(s,{on:{click:n.saveConfig}},[e._v("保存配置")])],1)],1)]):e._e()])}),[],!1,null,null,null,null).exports;export{A as _};
