import{l as e,n as t,D as a,q as i}from"./main.js?v=1714377894636";import{w as r,x as l,q as s,s as o}from"./element-lib.js?v=1714377894636";import{_ as m}from"./index85.js?v=1714377894636";import{_ as p}from"./index60.js?v=1714377894636";import{_ as n}from"./preload-helper.js?v=1714377894636";import{e as u,b as v,v as c,h as d,j as _}from"./vue-lib.js?v=1714377894636";import{g as f,aA as g,aB as y,aC as L,aD as h,aE as b,aF as x,aG as C}from"./site.store.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./check.js?v=1714377894636";const j=t(u({__name:"TotalLimit",props:{compData:{default:()=>{}},isConfig:{type:Boolean,default:!1},siteData:null},setup(t,{expose:a}){var i;const r=t,{proxy:l}=_(),{refs:{siteInfo:s},getPhpModulesList:o}=f(),m=v([{title:"论坛/博客",value:0,items:{perserver:300,perip:25,limit_rate:512}},{title:"图片站",value:1,items:{perserver:200,perip:10,limit_rate:1024}},{title:"下载站",value:2,items:{perserver:50,perip:3,limit_rate:2048}},{title:"商城",value:3,items:{perserver:500,perip:10,limit_rate:2048}},{title:"门户",value:4,items:{perserver:400,perip:15,limit_rate:1024}},{title:"企业",value:5,items:{perserver:60,perip:10,limit_rate:512}},{title:"视频",value:6,items:{perserver:150,perip:4,limit_rate:1024}},{title:"自定义",value:7,items:{perserver:"",perip:"",limit_rate:""}}]),p=v(!1),u=v(""),j=c({value:!0,perserver:300,perip:25,limit_rate:512,type:0}),w=v(!1),D=v(null==(i=r.compData.project_type)?void 0:i.toLowerCase()),F=async t=>{l.$refs.totalLimitFormRef.validate((async a=>{if(!a)return;let i=l.$load("正在设置流量，请稍后...");try{if(r.isConfig||r.compData.isConfig){let e;return e="php"!==D.value&&"proxy"!==D.value?await L({perserver:j.perserver,perip:j.perip,limit_rate:j.limit_rate,site_id:r.compData.id},"nginx"===D.value?"proxy":D.value):await h({id:r.compData.id,perserver:j.perserver,perip:j.perip,limit_rate:j.limit_rate}),l.$message.request(e),void $()}const a=await b({...j,close_limit_net:j.value?0:1,site_ids:JSON.stringify(r.compData.map((e=>e.id)))});let i=[];await a.data.errors.forEach((e=>{i.push({...e,name:r.compData.find((t=>t.id===e.id)).name})})),await a.data.succeed.forEach((e=>{i.push({...e,name:r.compData.find((t=>t.id===e.id)).name})})),await e({title:"批量设置结果",area:42,component:()=>n((()=>import("./index63.js?v=1714377894636")),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]),import.meta.url),compData:{resultData:i,resultTitle:"结果"}}),o(),t()}catch(s){}finally{i.close()}}))},k=e=>{j.perserver=m.value[e].items.perserver,j.perip=m.value[e].items.perip,j.limit_rate=m.value[e].items.limit_rate},$=async()=>{w.value=!0;try{let e;if(e="php"!==D.value&&"proxy"!==D.value?await x({site_id:r.compData.id},"nginx"===D.value?"proxy":D.value):await C({id:r.compData.id}),!e.data.hasOwnProperty("limit_rate"))return p.value=!0,u.value=e.data.msg;j.value=!!e.data.value,j.limit_rate=e.data.limit_rate,j.perip=e.data.perip,j.perserver=e.data.perserver,Object.values(e.data).every((e=>0===e))?(j.value=!1,j.type=0,k(0)):(j.type=e.data.value-1,j.value=!0),-1===j.type&&(j.type=7)}catch(e){}finally{w.value=!1}};return a({getLimitRate:$}),d((async()=>{var e;let t=null==(e=s.value.project_type)?void 0:e.toLowerCase();"node"===t&&(t="nodejs"),D.value=t,r.isConfig||r.compData.isConfig?await $():await k(0)})),{__sfc:!0,vm:l,props:r,siteInfo:s,getPhpModulesList:o,planList:m,rules:{perserver:[{required:!0,message:"请输入并发限制",trigger:"blur"}],perip:[{required:!0,message:"请输入单IP限制",trigger:"blur"}],limit_rate:[{required:!0,message:"请输入流量限制",trigger:"blur"}]},maskLayer:p,maskTip:u,totalLimitForm:j,viewLoading:w,siteType:D,handleCheckChange:async e=>{if(r.isConfig||r.compData.isConfig)try{if(j.value)F();else{let e,t=l.$load("正在关闭流量限制，请稍后...");e="html"===D.value?await g({site_id:Number(r.compData.id)},D.value):await y({id:r.compData.id}),t.close(),l.$message.request(e),await $()}}catch(t){}},onConfirm:F,handleChange:k,getLimitRate:$}}}),(function(){var e=this,t=e._self._c,n=e._self._setupProxy;return t("div",{staticClass:"p-20x"},[t(p,{attrs:{visible:n.maskLayer,width:"36rem"}},[e._v(" "+e._s(n.maskTip)+" ")]),t(r,{directives:[{name:"loading",rawName:"v-loading",value:n.viewLoading,expression:"viewLoading"}],ref:"totalLimitFormRef",attrs:{model:n.totalLimitForm,rules:n.rules}},[t(l,{attrs:{label:"是否启用"}},[t(a,{on:{change:n.handleCheckChange},model:{value:n.totalLimitForm.value,callback:function(t){e.$set(n.totalLimitForm,"value",t)},expression:"totalLimitForm.value"}},[e._v("启用流量控制")])],1),t(l,{attrs:{label:"限制方案"}},[t(s,{staticClass:"w-[24rem]",on:{change:n.handleChange},model:{value:n.totalLimitForm.type,callback:function(t){e.$set(n.totalLimitForm,"type",t)},expression:"totalLimitForm.type"}},e._l(n.planList,(function(e){return t(o,{key:e.value,attrs:{label:e.title,value:e.value}})})),1)],1),t(l,{attrs:{label:"并发限制",prop:"perserver"}},[t(m,{attrs:{type:"number",min:0},model:{value:n.totalLimitForm.perserver,callback:function(t){e.$set(n.totalLimitForm,"perserver",t)},expression:"totalLimitForm.perserver"}}),t("span",{staticClass:"text-[#999] text-[1.2rem]"},[e._v("* 限制当前站点最大并发数")])],1),t(l,{attrs:{label:"单IP限制",prop:"perip"}},[t(m,{attrs:{type:"number",min:0},model:{value:n.totalLimitForm.perip,callback:function(t){e.$set(n.totalLimitForm,"perip",t)},expression:"totalLimitForm.perip"}}),t("span",{staticClass:"text-[#999] text-[1.2rem]"},[e._v("* 限制单个IP访问最大并发数")])],1),t(l,{attrs:{label:"流量限制",prop:"limit_rate"}},[t(m,{attrs:{type:"number",min:0},model:{value:n.totalLimitForm.limit_rate,callback:function(t){e.$set(n.totalLimitForm,"limit_rate",t)},expression:"totalLimitForm.limit_rate"}}),t("span",{staticClass:"text-[#999] text-[1.2rem]"},[e._v("* 限制每个请求的流量上限（单位：KB）")])],1),e.isConfig||e.compData.isConfig?t(l,{attrs:{label:" "}},[t(i,{on:{click:n.onConfirm}},[e._v(e._s(n.totalLimitForm.value?"保存":"保存并启用"))])],1):e._e()],1)],1)}),[],!1,null,"a0489b65",null,null).exports;export{j as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["./index63.js?v=1714377894636","./index39.js?v=1714377894636","./element-lib.js?v=1714377894636","./__commonjsHelpers__.js?v=1714377894636","./vue-lib.js?v=1714377894636","./public-lib.js?v=1714377894636","./main.js?v=1714377894636","./modulepreload-polyfill.js?v=1714377894636","./preload-helper.js?v=1714377894636","./request-lib.js?v=1714377894636","./locales-lib.js?v=1714377894636","./element-lib.js?v=1714377894636"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
