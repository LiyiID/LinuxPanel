import{o as e,aS as a,Q as t,n as s,D as o,a as r,q as l,b as i}from"./main.js?v=1714377894636";import{w as p,x as d,j as n,y as m,ab as c,q as u,s as v,z as y}from"./element-lib.js?v=1714377894636";import{_ as f}from"./index85.js?v=1714377894636";import"./radio-button.js?v=1714377894636";import{e as h,b,h as _,i as g,j as A}from"./vue-lib.js?v=1714377894636";import{g as F,bb as w,b6 as x,A as j,bc as k,bd as D,B as C}from"./site.store.js?v=1714377894636";import{r as E}from"./site.rules.js?v=1714377894636";import{o as P}from"./confirm.js?v=1714377894636";import{y as $}from"./site.popup.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./check.js?v=1714377894636";import"./config.js?v=1714377894636";import"./index38.js?v=1714377894636";import"./index45.js?v=1714377894636";import"./element-ui.common.js?v=1714377894636";import"./date-util.js?v=1714377894636";import"./vdom.js?v=1714377894636";import"./index62.js?v=1714377894636";import"./cascader-panel.js?v=1714377894636";const q=s(h({__name:"AddSitePopup",props:{compData:{default:{rowData:{},isEdit:!1}}},setup(s,{expose:o}){const r=s,{proxy:l}=A(),{getModulesList:i}=F(),p=b(!1),d=b(),n=b(!1),m=b("1"),c=b({rfile:"",pjname:"",port:"",release_firewall:!1,path:"",framework:"django",stype:"uwsgi",xsgi:"wsgi",requirement_path:"",auto_run:!1,venv_path:"",version:"",parm:""}),u=b([]),v=b([]),y=b("正在恢复版本..."),f=b(!1),h=async()=>{var e;try{const a=await j();u.value=[],u.value=a.data.cpy_installed.concat(a.data.pypy_installed),c.value.version=a.data.cpy_installed[0]||"",v.value=a.data.command_path.filter((e=>"project"===e.type)),c.value.venv_path=null==(e=v.value[0])?void 0:e.python_path}catch(a){}},q=async e=>{let a=Object.assign({},c.value);"1"===m.value?delete a.venv_path:delete a.version,"python"===a.stype||"command"===a.stype||delete a.parm,P({$refs:d.value,loading:{disable:p},request:async()=>{var e;return r.compData.isEdit?await k({data:JSON.stringify({name:null==(e=r.compData.rowData)?void 0:e.name,data:a})}):await D({data:JSON.stringify(a)})},async complete(){i("python")}})};let R=null;const S=()=>{R=t({route:"/sock_shell",onMessage:M})},M=(e,a)=>{const t=a.data;y.value+="\n"+t,t.includes("成功")&&(f.value=!1,null==R||R.close(),y.value="正在恢复版本...")},N=async()=>{var e;try{let a=(await C({data:JSON.stringify({name:null==(e=r.compData)?void 0:e.rowData.name})},"python")).data;a.isEdit=!0,c.value={...null==a?void 0:a.project_config,project_ps:null==a?void 0:a.ps,is_power_on:!!(null==a?void 0:a.project_config.is_power_on),not_install_pkg:!!(null==a?void 0:a.project_config.not_install_pkg)}}catch(a){}};return _((async()=>{var e;n.value=!0,await h(),n.value=!1,r.compData.isEdit&&N();const a=JSON.parse(null!=(e=sessionStorage.getItem("BT-CONFIG"))?e:"{}").sites_path;a&&(c.value.project_path=a)})),o({onConfirm:q}),g((()=>{null==R||R.close()})),{__sfc:!0,props:r,vm:l,getModulesList:i,formDisabled:p,pyAddFormRef:d,formLoading:n,test:m,pyAddForm:c,versionData:u,frameData:v,recoverMessage:y,recoverPopup:f,recoverVersion:async()=>{var e;try{f.value=!0,w({name:null==(e=r.compData.rowData)?void 0:e.name}),S(),null==R||R.send({"x-http-token":window.vite_public_request_token}),null==R||R.send("tail -f /www/server/python_project/vhost/logs/simple_flask2_update.log")}catch(a){}},onPathChange:()=>{a({type:"file",path:c.value.rfile,change:e=>{c.value.rfile=e}})},checkPortUse:async()=>{if(c.value.port)try{const e=await x({port:c.value.port},"python");e.status||(l.$message.request(e),c.value.port="")}catch(e){}},onRootPathChange:()=>{a({type:"dir",path:c.value.path,change:e=>{var a;if(e){c.value.path=e;let t=null==(a=e.substring(e.lastIndexOf("/")+1))?void 0:a.replace(/\./g,"_").replace(/\/\//g,"/");c.value.pjname=t}}})},getVersion:h,onConfirm:q,useSocket:R,createWebSocket:S,onWSReceive:M,onPathChangeRequirement:()=>{a({type:"file",path:c.value.requirement_path,change:e=>{c.value.requirement_path=e}})},getInfo:N,isRelease:e,rules:E,sdkVersionManger:$}}}),(function(){var e=this,a=e._self._c,t=e._self._setupProxy;return a("div",{staticClass:"p-20x"},[a(p,{directives:[{name:"loading",rawName:"v-loading",value:t.formLoading,expression:"formLoading"}],ref:"pyAddFormRef",attrs:{model:t.pyAddForm,"label-width":"100px",rules:t.rules,disabled:t.formDisabled}},[a(d,{attrs:{label:"项目路径",prop:"path"}},[a(f,{attrs:{width:"42rem","icon-type":!e.compData.isEdit&&"folder",disabled:e.compData.isEdit,placeholder:"项目的根路径"},on:{folder:t.onRootPathChange},model:{value:t.pyAddForm.path,callback:function(a){e.$set(t.pyAddForm,"path",a)},expression:"pyAddForm.path"}})],1),a(d,{attrs:{label:"项目名称",prop:"pjname"}},[a(f,{attrs:{disabled:e.compData.isEdit,width:"42rem",placeholder:"请输入Python项目名称"},model:{value:t.pyAddForm.pjname,callback:function(a){e.$set(t.pyAddForm,"pjname",a)},expression:"pyAddForm.pjname"}})],1),a(d,{attrs:{label:"运行文件",prop:"rfile"}},[a(f,{attrs:{placeholder:"项目的运行文件",width:"42rem","icon-type":"folder"},on:{folder:t.onPathChange},model:{value:t.pyAddForm.rfile,callback:function(a){e.$set(t.pyAddForm,"rfile",a)},expression:"pyAddForm.rfile"}})],1),a(d,{attrs:{label:"项目端口",prop:"port"}},[a("div",{staticClass:"flex items-center"},[a(f,{staticClass:"mr-12x",attrs:{width:"20rem",type:"number",placeholder:"项目的真实端口"},on:{blur:t.checkPortUse},model:{value:t.pyAddForm.port,callback:function(a){e.$set(t.pyAddForm,"port",a)},expression:"pyAddForm.port"}}),e.compData.isEdit?e._e():a(o,{model:{value:t.pyAddForm.release_firewall,callback:function(a){e.$set(t.pyAddForm,"release_firewall",a)},expression:"pyAddForm.release_firewall"}},[e._v(" 放行端口 "),a(n,{staticClass:"item",attrs:{effect:"dark",content:"选中将在防火墙安全组放行监听端口，放行后该项目可在外网访问",placement:"right"}},[a("i",{staticClass:"el-icon-question text-warning"})])],1)],1)]),e.compData.isEdit||t.isRelease?e._e():a(d,{attrs:{label:"Python环境"}},[a(m,{attrs:{size:"small"},model:{value:t.test,callback:function(e){t.test=e},expression:"test"}},[a(c,{attrs:{label:"1"}},[e._v("从已有版本新建环境")]),a(c,{attrs:{label:"2"}},[e._v("选择已有环境")])],1)],1),a(d,{attrs:{label:"Python版本"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:"1"===t.test,expression:"test === '1'"}],staticClass:"flex items-center"},[a(u,{attrs:{disabled:t.isRelease&&e.compData.isEdit},model:{value:t.pyAddForm.version,callback:function(a){e.$set(t.pyAddForm,"version",a)},expression:"pyAddForm.version"}},e._l(t.versionData,(function(e){return a(v,{key:e,attrs:{value:e,label:e}})})),1),a(r,{staticClass:"ml-8x",on:{click:function(e){t.sdkVersionManger("py",t.getVersion())}}},[e._v("版本管理")]),e.compData.isEdit&&!t.isRelease?a(r,{staticClass:"ml-8x",on:{click:t.recoverVersion}},[e._v("恢复版本")]):e._e()],1)]),a(d,{attrs:{label:"框架"}},[a("div",{staticClass:"flex items-center"},[a(u,{attrs:{disabled:e.compData.isEdit},model:{value:t.pyAddForm.framework,callback:function(a){e.$set(t.pyAddForm,"framework",a)},expression:"pyAddForm.framework"}},[a(v,{attrs:{label:"django",value:"django"}}),a(v,{attrs:{label:"Flask",value:"flask"}}),a(v,{attrs:{label:"Sanic",value:"sanic"}}),a(v,{attrs:{label:"python",value:"python"}})],1),a("span",{staticClass:"ml-8x"},[e._v("* 未使用框架请选择python")])],1)]),a(d,{attrs:{label:"运行方式"}},[a(m,{model:{value:t.pyAddForm.stype,callback:function(a){e.$set(t.pyAddForm,"stype",a)},expression:"pyAddForm.stype"}},[a(y,{attrs:{label:"uwsgi"}}),a(y,{attrs:{label:"gunicorn"}}),a(y,{attrs:{label:"python"}}),t.isRelease?e._e():a(y,{attrs:{label:"command"}},[e._v("自定义")])],1)],1),"python"!=t.pyAddForm.stype&&"command"!=t.pyAddForm.stype?a(d,{attrs:{label:"网络协议"}},[a(u,{model:{value:t.pyAddForm.xsgi,callback:function(a){e.$set(t.pyAddForm,"xsgi",a)},expression:"pyAddForm.xsgi"}},[a(v,{attrs:{label:"wsgi",value:"wsgi"}}),a(v,{attrs:{label:"asgi",value:"asgi"}})],1)],1):e._e(),"python"==t.pyAddForm.stype||"command"==t.pyAddForm.stype?a(d,{attrs:{label:"python"!==t.pyAddForm.stype?"自定义命令":"启动方式"}},[a(f,{attrs:{placeholder:"自定义的启动参数",width:"42rem"},model:{value:t.pyAddForm.parm,callback:function(a){e.$set(t.pyAddForm,"parm",a)},expression:"pyAddForm.parm"}})],1):e._e(),a(d,{attrs:{label:"安装依赖包"}},[a(f,{attrs:{width:"42rem","icon-type":!e.compData.isEdit&&"folder",disabled:e.compData.isEdit,placeholder:"如需安装依赖包，请填写依赖包的文件地址【为空则不安装依赖包】"},on:{folder:t.onPathChangeRequirement},model:{value:t.pyAddForm.requirement_path,callback:function(a){e.$set(t.pyAddForm,"requirement_path",a)},expression:"pyAddForm.requirement_path"}})],1),e.compData.isEdit?a("div",{staticClass:"my-20x"},["python"!=t.pyAddForm.stype&&"command"!=t.pyAddForm.stype?a(d,{attrs:{label:"进程数",prop:"processes"}},[a("div",{staticClass:"flex items-center"},[a(f,{attrs:{width:"16rem"},model:{value:t.pyAddForm.processes,callback:function(a){e.$set(t.pyAddForm,"processes",a)},expression:"pyAddForm.processes"}}),a(d,{attrs:{label:"线程数",prop:"threads"}},[a(f,{attrs:{width:"16rem"},model:{value:t.pyAddForm.threads,callback:function(a){e.$set(t.pyAddForm,"threads",a)},expression:"pyAddForm.threads"}})],1)],1)]):e._e(),a(d,{attrs:{label:"启动用户"}},[a(u,{staticClass:"w-[16rem]",model:{value:t.pyAddForm.user,callback:function(a){e.$set(t.pyAddForm,"user",a)},expression:"pyAddForm.user"}},[a(v,{attrs:{label:"www",value:"www"}}),a(v,{attrs:{label:"root",value:"root"}})],1)],1),e.compData.isEdit?a(d,{attrs:{label:"通信方式"}},[a(u,{staticClass:"w-[16rem]",model:{value:t.pyAddForm.is_http,callback:function(a){e.$set(t.pyAddForm,"is_http",a)},expression:"pyAddForm.is_http"}},[a(v,{attrs:{label:"http",value:!0}}),a(v,{attrs:{label:"socket",value:!1}})],1)],1):e._e()],1):e._e(),e.compData.isEdit?e._e():a("ul",{staticClass:"mt-20x leading-8 text-[1.2rem] list-disc ml-48x"},[a("li",[e._v("执行命令：请输入项目需要携带的参数，默认请输入执行文件名")])]),e.compData.isEdit?a(d,{attrs:{label:" "}},[a(l,{on:{click:t.onConfirm}},[e._v("保存配置")])],1):e._e()],1),a(i,{attrs:{title:"正在恢复版本,请稍后...",visible:t.recoverPopup,area:[50,36]},on:{"update:visible":function(e){t.recoverPopup=e}}},[a("div",{staticClass:"bg-[#333] p-12x h-full text-white overflow-auto"},[a("pre",{domProps:{innerHTML:e._s(t.recoverMessage)}})])])],1)}),[],!1,null,"dca786e6",null,null).exports;export{q as default};
