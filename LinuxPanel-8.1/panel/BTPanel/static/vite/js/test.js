import{a1 as e,f as n,bx as i,a2 as t,K as s,b4 as a,b5 as l,b6 as o,b7 as p,b8 as r,b9 as g,ba as u,n as c,_ as m,a as f,q as v,R as d}from"./main.js?v=1714377894636";import{_}from"./index41.js?v=1714377894636";import{_ as h}from"./index45.js?v=1714377894636";import{e as y,A as I,v as w,b,f as C,c as x,h as D,j as M}from"./vue-lib.js?v=1714377894636";import{g as V}from"./files.js?v=1714377894636";import{d as j,r as k}from"./check.js?v=1714377894636";import{c as O,h as E,d as S,s as A,a as P}from"./popup.js?v=1714377894636";import{g as $}from"./soft.store.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./element-lib.js?v=1714377894636";import"./index85.js?v=1714377894636";import"./index118.js?v=1714377894636";import"./index39.js?v=1714377894636";import"./index59.js?v=1714377894636";import"./index119.js?v=1714377894636";import"./soft.api.js?v=1714377894636";const B=c(y({__name:"test",props:{compData:{default:()=>({name:"",type:"",pluginInfo:{},softData:{name:"",endtime:0,setup:!1,pid:"",type:0}})}},emits:["close","refresh"],setup(c,{emit:m}){var f;const v=c,{softData:d,pluginInfo:_}=v.compData,{proxy:h}=M(),{isInstall:y}=I(e()),{refs:{speedInstallView:B}}=$(),U=w({isBeta:!!v.compData.isBeta&&v.compData.isBeta,title:"",dependnetFlag:!1,arrs:["apache","nginx","mysql"],speedConfig:{}}),F=w({name:null==(f=v.compData)?void 0:f.name,pluginInfo:{},info:{},newVersion:"",changeUpdateTime:"",PluginUpgradesData:[]}),T=w({imgArrValue:0,imgArr:[]}),N=b({selectValue:"",selectOption:[],compile:!1,phpVersion:"",size:!1}),L=b("/static/img/soft_ico/icon_plug.svg");C((()=>F.pluginInfo.name),(()=>{var e;F.pluginInfo.name&&(L.value="/static/img/soft_ico/ico-"+((null==(e=F.pluginInfo.name)?void 0:e.includes("php-"))?"php":F.pluginInfo.name)+".png")}),{deep:!0});const q=x((()=>F.changeUpdateTime?F.changeUpdateTime:F.PluginUpgradesData&&F.PluginUpgradesData.length&&F.PluginUpgradesData[0].update_time?n(F.PluginUpgradesData[0].update_time,"yyyy/MM/dd"):"暂无")),z=b([[7,"免","border-[#E1E1E1] text-[#9a9a9a]"],[8,"专","border-[#F9EE9E] text-[#FFC82F]"],[12,"企","border-[#E8D6B3] text-[#A3782F]"]]),H=async e=>{var n;try{switch(N.value.selectOption=[],v.compData.type){case"i":U.title="安装",v.compData.update&&(U.title="更新");break;case"u":U.title="更新";break;case"r":U.title="修复";break;default:U.title="安装"}if(e)F.pluginInfo=v.compData.pluginInfo,F.pluginInfo||(F.pluginInfo=v.compData.softData);else{const{data:e}=await t({sName:F.name});F.pluginInfo=e}if(F.pluginInfo.introduction){const e=F.pluginInfo.introduction.split(";");T.imgArr=[],e.forEach(((e,n)=>{const i=e.split("|");T.imgArr.push({title:i[0],src:F.name.indexOf("php-")>-1?"https://www.bt.cn/Public/new/plugin/php/"+i[1]:"https://www.bt.cn/Public/new/plugin/"+(null==F?void 0:F.name)+"/"+i[1]})}))}await Q(),U.dependnetFlag=!F.pluginInfo.dependnet.need&&!F.pluginInfo.dependnet.selected,s(F.pluginInfo.dependnet.need)&&(U.dependnetFlag=!F.pluginInfo.dependnet.need.length&&!F.pluginInfo.dependnet.selected.length),U.arrs.includes(F.name)?(F.pluginInfo.versions.length>1?(F.pluginInfo.versions.forEach(((e,n)=>{N.value.selectOption.push({title:F.name+e.m_version,key:n})})),N.value.selectValue=N.value.selectOption[0].key):N.value.phpVersion=F.name+(F.name.indexOf("php-")>-1?"":F.pluginInfo.versions[0].m_version),N.value.compile=!0,N.value.size=!0):Array.isArray(F.pluginInfo.versions)&&F.pluginInfo.versions.length>1?(N.value.selectOption=[],F.pluginInfo.versions.forEach(((e,n)=>{let i=1===e.beta?" Beta":" Stable";N.value.selectOption.push({title:e.m_version+"."+e.version+i,key:n})})),N.value.selectValue=N.value.selectOption[0].key,N.value.size=!0):F.name.indexOf("php-")>=0?(N.value.selectOption=[],N.value.selectValue=null==(n=F.name)?void 0:n.split("php-")[1],F.pluginInfo.other_php.forEach(((e,n)=>{N.value.selectOption.push({id:e.id,title:e.name,key:e.version})})),N.value.compile=!0):Array.isArray(F.pluginInfo.versions)?F.pluginInfo.install_version=F.pluginInfo.versions[0]:F.pluginInfo.install_version=F.pluginInfo.version}catch(i){}},Q=async()=>{try{const n=await a({plugin_name:F.name,show:1});if(F.PluginUpgradesData=n,U.isBeta){let e=n[n.length-1];F.info=e.beta?e:{}}else F.info=n[0];if("i"===v.compData.type&&n.forEach(((e,n)=>{e.m_version+"."+e.version===F.pluginInfo.versions&&(F.info=e)})),F.pluginInfo.versions.length>1&&F.pluginInfo.version){let e=F.pluginInfo.m_version+"."+F.pluginInfo.version;F.pluginInfo.m_version||(e=F.pluginInfo.version),F.pluginInfo.versions.some(((n,i)=>{const t=j(e,n.m_version+"."+n.version);if(0==t&&(F.newVersion=n.m_version+"."+n.version),-1==t)return F.newVersion=n.m_version+"."+n.version,!0}))}else{var e=F.pluginInfo.versions[0];F.newVersion=e.m_version+"."+e.version}}catch(n){}},R=async()=>{var e;if("r"===v.compData.type)return void K(F.pluginInfo.name,F.pluginInfo.tmp_path,{install_opt:"r"});const n=F.pluginInfo,t=n.type;if(y.value&&await Y(),U.isBeta,N&&5==t&&"更新"!==U.title)F.pluginInfo.versions.length>1?(F.pluginInfo.install_version=n.versions.filter(((e,n)=>n===N.value.selectValue))[0],await G(F.pluginInfo)):(F.pluginInfo.install_version=F.pluginInfo.versions[0],F.pluginInfo.install_type="1",await X(F.pluginInfo));else if(5===t&&(null==(e=F.pluginInfo.name)?void 0:e.indexOf("php-"))>-1)W({title:"正在更新，请稍后...",status:!0,soft:{type:t}}),X(F.pluginInfo);else{if(11===t||v.compData.update)try{return await h.$confirm({title:"安全验证",width:"35rem",useHtml:!0,message:'<span class="text-danger">'.concat("宝塔"===F.pluginInfo.authorauthor?"更新过程可能会导致服务中断,是否继续升级？<br>建议您在服务器负载闲时进行软件更新。":"安装第三方插件存在一定的安全风险，是否继续安装？","</span>"),icon:"warning"}),await K(n.name,n.tmp_path,n),!1}catch(c){}if(""!=N.value.selectValue)if(Array.isArray(F.pluginInfo.versions)?n.install_version=n.versions.filter(((e,n)=>n===N.value.selectValue))[0]:n.install_version=n.versions,n.tmp_path)await K(n.name,n.tmp_path,n);else try{const e={sName:n.name,version:n.install_version.m_version,min_version:n.install_version.version};n.install_type&&(e.type=n.install_type);const i=await l(e);if(i.msg&&!i.status)return h.$message.error(i.msg);await K(i.name,i.tmp_path,i)}catch(c){}else if(n.version&&n.versions.length>1)for(var s=0;s<n.versions.length;s++){var a=n.versions[s],p=j(n.version,a.m_version+"."+a.version);if(0===p){h.$message.error("当前已是最新版本");break}if(p<0){const e={sName:n.name,version:n.versions[0].m_version,min_version:n.versions[0].version,upgrade:n.versions[0].m_version};"mysql"===n.name&&await h.$confirm({type:"calc",title:"更新MySQL【".concat(n.versions[0].m_version,".").concat(n.versions[0].version,"】"),width:"35rem",useHtml:!0,message:'<span class="text-[#000000] text-[1.2rem]">更新过程可能会导致服务中断,您真的现在就将【MySQL】更新到【'.concat(n.versions[0].m_version,".").concat(n.versions[0].version,"】吗？</span>\n                            <br>\n                            <span>更新数据库有风险，建议在更新前先备份您的数据库.如果您的是云服务器，强烈建议您在更新前做一个快照.建议您在服务器负载闲时进行软件更新.</span>")});var r=h.$load("正在获取插件安装信息，请稍候");const i=await l(e);B.value=!0,r.close(),5===t?(await o(),h.$emit("close")):await K(n.name,i.tmp_path,i);break}}else{if("更新"!=U.title){const e={sName:n.name,version:n.versions[0].m_version,min_version:n.versions[0].version};i(n.versions)&&(e.version=n.versions,e.min_version=n.versions);const t=await l(e);return K(n.name,t.tmp_path,t)}var g=!!(a=n.versions[0]).beta&&a.beta,u=a.m_version+"."+a.version;n.version!=u&&g==n.is_beta&&(W({title:"正在更新，请稍后...",status:!0,soft:{type:t}}),X(n))}}},J=async()=>{await S(F.pluginInfo)},K=async(e,n,i)=>{W({title:"正在安装【"+i.title+"】，可能需要几分钟时间，请耐心等候!",status:!0},(async()=>{const t=await u({plugin_name:e,tmp_path:n,install_opt:i.install_opt});ne(),B.value=!1,h.$message.request(t)}))},W=(e,n)=>(e.soft||(e.soft={type:10}),5===e.soft.type?(n&&n(),!1):10!==e.soft.type||e.status?(U.speedConfig=e,U.speedConfig.msg="正在下载中...",A(U.speedConfig),m("close"),void(n&&n())):(n&&n(),!1)),G=async e=>{const n=e.install_version,i=n.m_version,t=n.version;k(e.title,"-"+i,""),10===e.type?(await h.$confirm({title:"信息",width:"35rem",message:"您真的要安装".concat(5!==e.type?e.title:e.title+"-"+i,"吗？")}),await X(e)):5===e.type&&e.versions.length<2?(v.compData.type=e.install_opt,v.compData.name=e.name,await H(!1)):(await X(e),5!==e.type&&await Z({pluginName:e.name,name:e.title,version:i,minVersion:t}))},X=async e=>{try{const n=h.$load("正在获取插件安装信息，请稍候");10===e.type&&0===e.endtime&&await p({pid:e.id,cycle:999,type:0});const i=await l({sName:e.name,version:e.install_version.m_version,min_version:e.install_version.version,type:e.install_type?e.install_type:""});if(n.close(),i.install_opt)return v.compData.type=i.install_opt,v.compData.name=i.name,H(!1);i.size;if((await r()).data>0&&5===e.type&&(h.$emit("close"),o(),!i.status))return h.$message.error(i.msg);i.msg.indexOf("依赖以下软件")>-1&&(v.compData.type=i.install_opt,v.compData.name=i.name,N.value.size=!0,H(!1))}catch(n){}},Y=async()=>{try{const e=["openlitespeed","nginx","apache"],n=await V(),i=/\[(.*)\]/;n.task&&n.task.forEach(((n,t)=>{const s=n.name.match(i),a=s[1].split("-");return e.indexOf(F.name)>-1&&e.indexOf(a[0])>-1?h.$message.error("存在同类型的环境正在安装，请删除重试！"):s[1]===F.name||a[0]===F.name?h.$message.error("当前插件正在安装，请稍后重试！"):void 0}))}catch(e){}},Z=async(e,n)=>{if(U.speedConfig=e,await P(U.speedConfig),n)try{await g({plugin_name:e.pluginName})}catch(i){}else;},{getSoftTableList:ee}=$(),ne=()=>{window.location.href.indexOf("soft")>-1&&ee(),d&&d.callBack&&d.callBack(),F.pluginInfo.callback&&F.pluginInfo.callback(),d||(window.location.reload(),localStorage.clear(),sessionStorage.clear())};return C((()=>v.compData),(()=>{H(!0)})),D((()=>{U.isBeta=!!v.compData.isBeta&&v.compData.isBeta,F.name=v.compData.name,H(!0),T.imgArr=[],N.value={selectValue:"",selectOption:[],compile:!1,phpVersion:"",size:!1},F.info={}})),{__sfc:!0,props:v,softData:d,pluginInfo:_,emits:m,vm:h,isInstall:y,speedInstallView:B,state:U,pluginMsg:F,pluginShow:T,config:N,pluginImgSrc:L,pluginUpdateTime:q,tagList:z,installPlugin:H,handleVersionChange:e=>{N.value.selectValue=e,F.PluginUpgradesData.forEach(((i,t)=>{t==Number(e)&&(F.changeUpdateTime=n(i.update_time,"yyyy/MM/dd"))}))},showPluginInfo:Q,isEmptyObject:e=>0===Object.keys(e).length,installEvent:async e=>{e?R():J()},installPluginEvent:R,installEnviromentEvent:J,inputPackage:K,showSpeedWindow:W,installSoft:G,getInstallPlugin:X,getRealtimeTasks:Y,monitorSoftDownloadSpeed:Z,getSoftTableList:ee,closeInstall:ne,isString:i,compileInstallDialog:O,historyVersionDialog:E}}}),(function(){var e,n,i,t,s=this,a=s._self._c,l=s._self._setupProxy;return a("div",{staticClass:"install-plugin"},[a("div",{staticClass:"install-plugin-header"},[a("div",{staticClass:"install-plugin-header-left"},[a(m,{staticClass:"h-[4rem] mt-[0.6rem]",attrs:{src:l.pluginImgSrc,custom:!0}}),a("div",{staticClass:"install-plugin-header-left-title"},[a("div",{staticClass:"flex items-center text-[#333]"},[a("span",{staticClass:"text-[2rem] font-bold"},[s._v(s._s((null==(e=l.pluginMsg.pluginInfo)?void 0:e.title)||(null==(n=l.pluginMsg.pluginInfo)?void 0:n.name)))]),l.config.compile?s._e():a("div",{staticClass:"install-plugin-header-left-title-tag"},[s._l(l.tagList,(function(e,n){return[!e||"boolean"!=typeof e[0]&&e[0]!==l.pluginMsg.pluginInfo.type?s._e():a("div",{key:n,staticClass:"install-plugin-header-left-title-tag-item",class:e[2]+" border-[0.1rem]"},[e&&"boolean"==typeof e[0]?a("i",{staticClass:"plugin_official_icon"}):s._e(),a("span",[s._v(s._s(e[1]))])])]}))],2)]),5!==l.pluginMsg.pluginInfo.type?a("div",{staticClass:"mt-[1rem]"},[a("span",{staticClass:"font-normal"},[s._v("更新时间：")]),a("span",{staticClass:"font-normal"},[s._v(" "+s._s(l.pluginUpdateTime)+" ")]),"更新"!==l.state.title?a(h):s._e(),"更新"!==l.state.title?a(f,{staticClass:"font-normal",on:{click:function(e){return l.historyVersionDialog(l.pluginMsg.pluginInfo)}}},[s._v(" 更新日志 ")]):s._e()],1):s._e(),a("div",{staticClass:"flex items-center mt-[1rem]"},["更新"===l.state.title?a("span",{staticClass:"font-normal"},[s._v(" 最新版本： "),a("span",[s._v(" "+s._s(l.state.isBeta?"测试版"+l.pluginMsg.info.m_version+"."+l.pluginMsg.info.version:l.pluginMsg.newVersion)+" ")])]):s._e(),l.config&&!l.config.selectOption.length?a("span",{staticClass:"ml-[.5rem] font-normal"},[s._v("当前版本："+s._s(Array.isArray(l.pluginMsg.pluginInfo.versions)?l.pluginMsg.pluginInfo.versions[0].m_version+"."+l.pluginMsg.pluginInfo.versions[0].version:l.isString(l.pluginMsg.pluginInfo.versions)?l.pluginMsg.pluginInfo.versions:l.pluginMsg.pluginInfo.version))]):s._e()])])],1),a("div",{staticClass:"flex items-center"},[l.config&&(l.config.selectOption.length||l.config.phpVersion)&&"安装"==l.state.title?a("div",[l.config.phpVersion?a("span",[s._v(s._s(l.config.phpVersion))]):[a(_,{staticClass:"mr-[1rem] w-[11.6rem]",attrs:{options:l.config.selectOption,change:l.handleVersionChange},model:{value:l.config.selectValue,callback:function(e){s.$set(l.config,"selectValue",e)},expression:"config.selectValue"}})]],2):s._e(),l.config&&l.config.compile&&"安装"==l.state.title?a(v,{attrs:{type:"default",disabled:l.pluginMsg.pluginInfo.dependnet.length>0},on:{click:function(e){l.compileInstallDialog(l.installEvent,l.isEmptyObject(l.pluginMsg.pluginInfo.dependnet)||l.state.dependnetFlag)}}},[s._v(" 编译安装 ")]):s._e(),a(v,{on:{click:function(e){l.installEvent(l.isEmptyObject(l.pluginMsg.pluginInfo.dependnet)||l.state.dependnetFlag)}}},[a("span",{staticClass:"flex items-center text-[1.4rem] font-normal"},["更新"===l.state.title?a("span",{staticClass:"update_plugin_button_icon"}):s._e(),s._v(" "+s._s(l.config&&5==l.pluginMsg.pluginInfo.type&&"更新"!=l.state.title?"极速安装":"立即"+l.state.title)+" ")])])],1)]),a("hr",{staticClass:"my-[3rem] border-[#eee]"}),l.pluginShow.imgArr.length?a("div",{staticClass:"install-plugin-introduce"},[a("div",{staticClass:"install-plugin-introduce-left"},[a("ul",{staticClass:"install-plugin-introduce-left-tab"},s._l(l.pluginShow.imgArr,(function(e,n){return a("li",{key:n,class:n===l.pluginShow.imgArrValue?"on":"",on:{click:function(e){l.pluginShow.imgArrValue=n}}},[s._v(" "+s._s(e.title)+" ")])})),0)]),a(d,{staticClass:"w-[40rem] max-h-[100%]",attrs:{src:l.pluginShow.imgArr[l.pluginShow.imgArrValue].src}})],1):s._e(),a("div",{staticClass:"install-plugin-detail"},["更新"!==l.state.title?[a("div",{staticClass:"install-plugin-detail-title"},[s._v("插件说明：")]),a("div",{staticClass:"install-plugin-detail-content",domProps:{innerHTML:s._s(l.pluginMsg.pluginInfo.ps)}})]:[a("div",{staticClass:"install-plugin-detail-title"},[s._v("更新日志：")]),a("div",{staticClass:"install-plugin-detail-content"},[s._v(" "+s._s(l.pluginMsg.pluginInfo.update_msg?l.pluginMsg.pluginInfo.update_msg:"暂无内容")+" ")])]],2),a("ul",{staticClass:"install-plugin-helper"},[l.config?s._e():a("li",[a("span",[s._v(" 插件来源"+s._s(l.pluginMsg.pluginInfo.author)+"，网址 "),a(f,{staticClass:"decoration-revert",attrs:{href:l.pluginMsg.pluginInfo.home,target:"_blank"}},[s._v(" "+s._s(l.pluginMsg.pluginInfo.home)+" ")])],1)]),s._m(0),"{}"!==JSON.stringify(l.pluginMsg.pluginInfo.dependnet)?a("li",[a("span",{staticClass:"red"},[s._v("请手动安装插件依赖环境，如果未安装，将无法正常使用该插件")])]):s._e(),(null==(i=l.pluginMsg.pluginInfo)?void 0:i.update)&&"mysql"===(null==(t=l.pluginMsg.pluginInfo)?void 0:t.name)?a("li",[a("span",{staticClass:"redr"},[s._v("更新数据库有风险,建议在更新前,先备份您的数据库！")])]):s._e(),!l.pluginMsg.pluginInfo.update?a("li",[a("span",[s._v("安装过程可能需要几分钟时间，请耐心等候!")])]):[s._m(1),s._m(2)]],2)])}),[function(){var e=this,n=e._self._c;return e._self._setupProxy,n("li",[n("span",[e._v("如果已存在此插件，文件将被替换！")])])},function(){var e=this,n=e._self._c;return e._self._setupProxy,n("li",[n("span",{staticClass:"red"},[e._v("更新过程可能会导致服务中断,请须知")])])},function(){var e=this,n=e._self._c;return e._self._setupProxy,n("li",[n("span",{staticClass:"red"},[e._v("建议您在服务器负载闲时进行软件更新")])])}],!1,null,"339e42ee",null,null).exports;export{B as default};
