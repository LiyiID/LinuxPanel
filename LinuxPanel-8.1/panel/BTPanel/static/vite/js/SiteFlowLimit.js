import{g as e,a as t,o as a,a2 as l,c as s,p as o,e as r,n as i,q as n,b as m}from"./main.js?v=1714377894636";import{_ as u}from"./index40.js?v=1714377894636";import{B as c,u as p,a9 as f,L as d,w as v,x as _,q as y,s as w,y as b,z as g,ac as h}from"./element-lib.js?v=1714377894636";import{_ as x}from"./index85.js?v=1714377894636";import{_ as F}from"./index39.js?v=1714377894636";import{_ as A}from"./index59.js?v=1714377894636";import"./index45.js?v=1714377894636";import{_ as C}from"./index60.js?v=1714377894636";import{_ as j}from"./index77.js?v=1714377894636";import{e as k,b as L,H as $,c as q,h as T,j as D}from"./vue-lib.js?v=1714377894636";import{cg as R,ch as S,ci as B,cj as N,ck as P,cl as I}from"./site.store.js?v=1714377894636";import M from"./TotalLimit.js?v=1714377894636";import{a as O}from"./confirm.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./config.js?v=1714377894636";import"./index42.js?v=1714377894636";import"./check.js?v=1714377894636";const z=i(k({__name:"SiteFlowLimit",props:{compData:{default:()=>({})}},setup(i){const n=i,{proxy:m}=D(),{refs:{authType:u}}=e(),p=L(!1),f=L(),d=L(!1),v=L(n.compData.tabName||"flowLimit"),_=L([]),y=L(!1),w=L(!1),b=L(!1),g=L({length:"--",request:"--"}),h=L({nginx_status:!1,total_status:!1,buy_status:!1}),x=L([{label:"1小时",value:"1h"},{label:"1天",value:"1day"},{label:"30天",value:"30day"},{label:"自然月",value:"month"}]),F=L([{label:"10分钟",value:"10m"},{label:"30分钟",value:"30m"}]),A=L({rule_type:"moment",time_period:"10m",limit_unit:"MB",limit_value:100,threshold_percentage:60,limit_action:"alert",module:[],cycle:3,type:"total"}),C=L([{label:"类型",prop:"rule_type",width:80},{label:"限额阈值",render:e=>$("span",[e.limit_value.replace("frequency","次")])},{label:"周期",prop:"time_period"},{label:"策略",prop:"rule",width:240},{label:"状态",render:e=>$("div",[$(c,{props:{value:e.limit_status,size:"mini"},on:{change:async t=>{await m.$confirm({title:(t?"开启":"关闭")+"流量限额配置",icon:"warning",message:(t?"开启":"关闭")+"检测到问题时将"+(t?"会":"不会")+"发送告警通知，是否继续？"});let a=m.$load("正在设置，请稍后...");try{const a=await R({id:e.id,limit_status:t,site_name:n.compData.name});m.$message.request(a),z()}catch(l){}finally{a.close()}}}})])},{label:"操作",align:"right",render:e=>$("div",[$(t,{on:{click:()=>{O({confirm:{title:"删除",icon:"warning",message:"是否删除此条流量限额配置？"},loading:"正在删除，请稍后...",request:async()=>await S({site_name:n.compData.name,id:e.id}),complete:z})}}},"删除")])}]),j=async()=>{try{const{data:e}=await l({sName:"total"});e.setup?(await k(),await z()):y.value=!0}catch(e){}},k=async()=>{b.value=!0;try{const e=await N({site_name:n.compData.name});g.value.length=s(e.data.length),g.value.request=s(e.data.request)}catch(e){}finally{b.value=!1}},z=async()=>{try{w.value=!0;const e=await B({site_name:n.compData.name});_.value=e.data}catch(e){}finally{w.value=!1}},Q=q((()=>{let e=A.value.time_period;return"moment"===A.value.rule_type?F.value.forEach((t=>{t.value===e&&(e=t.label)})):x.value.forEach((t=>{t.value===e&&(e=t.label)})),e})),V=()=>{p.value=!1,m.$refs.flowAlertFormRef.resetFields(),m.$refs.flowAlertFormRef.clearValidate()},E=async()=>{try{const{data:e}=await I({sName:"total"});h.value=e,h.value.nginx_status&&h.value.total_status||(y.value=!0)}catch(e){}};return T((async()=>{"flowQuota"===n.compData.tabName?(await E(),await j()):(d.value&&f.value.getLimitRate(),d.value=!0)})),{__sfc:!0,vm:m,props:n,authType:u,limitPopup:p,totalLimitConfigRef:f,refreshFlag:d,tabActive:v,tableData:_,maskLayer:y,tableLoading:w,viewLoading:b,totalForm:g,pluginStatus:h,totalOptions:x,momentOptions:F,rules:{limit_value:[{required:!0,message:"请输入限额阈值",trigger:"blur"}],threshold_percentage:[{required:!0,message:"请输入阈值百分比",trigger:"blur"}],cycle:[{required:!0,message:"请输入发送次数",trigger:"blur"}]},flowAlertForm:A,tableColumns:C,handleRadioChange:e=>{A.value.time_period="moment"===e?"10m":"1h"},handleTimeChange:e=>{A.value.time_period=e},handleClickTab:async e=>{"flowQuota"===e.name&&(await E(),await j())},getPluginMessage:j,getFlowNum:k,openBuyAndInstall:async e=>{if("buy"===e)o({sourceId:142});else try{const{data:e}=await l({sName:"total"});await r({name:e.name,type:e.type,pluginInfo:e})}catch(t){}},getFlowConfig:z,timeValue:Q,onConfirmLimit:async e=>{A.value.module.length?m.$refs.flowAlertFormRef.validate((async e=>{if(e){let e=m.$load("正在设置流量限额，请稍后..."),a={...A.value,site_name:n.compData.name,module:A.value.module.join(",")};"request"===A.value.type&&(a.limit_unit="frequency"),delete a.type;try{const e=await P(a);m.$message.request(e),V(),z(),A.value.module=[]}catch(t){}finally{e.close()}}else m.$message.error("请检查表单是否填写正确！")})):m.$message.error("请选择至少一种告警方式")},onCancelLimit:V,checkPluginStatus:E,isRelease:a,TotalLimit:M}}}),(function(){var e=this,a=e._self._c,l=e._self._setupProxy;return a("div",[a(j,{attrs:{type:"navtwo"},on:{"tab-click":l.handleClickTab},model:{value:l.tabActive,callback:function(e){l.tabActive=e},expression:"tabActive"}},[a(p,{attrs:{label:"流量限制",name:"flowLimit"}},[a(l.TotalLimit,{ref:"totalLimitConfigRef",attrs:{"is-config":!0,"comp-data":e.compData}})],1),l.isRelease?e._e():a(p,{attrs:{label:"流量限额",name:"flowQuota",lazy:!0}},[a(C,{attrs:{visible:l.maskLayer||!l.pluginStatus.buy_status&&"ltd"!==l.authType,width:!l.pluginStatus.total_status&&l.pluginStatus.buy_status?"44rem":"30rem"}},[a("div",{staticClass:"whitespace-normal leading-1.8rem"},["ltd"===l.authType||l.pluginStatus.buy_status?e._e():a("span",[e._v(" 当前为企业版专享功能，"),a(t,{on:{click:function(e){return l.openBuyAndInstall("buy")}}},[e._v("点击购买 ")])],1),l.pluginStatus.nginx_status?e._e():a("span",[e._v(" nginx版本小于1.18，请升级版本 ")]),l.pluginStatus.total_status?e._e():a("span",[e._v(" 当前尚未安装监控报表插件或版本小于7.6.0，"),a(t,{staticClass:"!text-[1.4rem]",on:{click:function(e){return l.openBuyAndInstall("install")}}},[e._v("点击安装 ")])],1)])]),a("div",{staticClass:"p-20x"},[a(f,{attrs:{title:"流量限额可设置多条规则，统计周期产生的流量/请求超过限额会告警",type:"warning",closable:!1,"show-icon":""}}),a("div",{directives:[{name:"loading",rawName:"v-loading",value:l.viewLoading,expression:"viewLoading"}],staticClass:"bg-[#FAFAFA] my-20x flex items-center border border-[#ddd] justify-evenly p-8x py-12x"},[a("div",{staticClass:"flex flex-col justify-center items-center"},[a("span",[e._v("当前流量")]),a("span",[e._v(e._s(l.totalForm.length))])]),a(d,{attrs:{direction:"vertical"}}),a("div",{staticClass:"flex flex-col justify-center items-center"},[a("span",[e._v("当前请求数")]),a("span",[e._v(e._s(l.totalForm.request))])])],1),a(A,{scopedSlots:e._u([{key:"header-left",fn:function(){return[a(n,{on:{click:function(e){l.limitPopup=!0}}},[e._v("添加流量限额配置")])]},proxy:!0},{key:"content",fn:function(){return[a(F,{directives:[{name:"loading",rawName:"v-loading",value:l.tableLoading,expression:"tableLoading"}],attrs:{column:l.tableColumns,data:l.tableData}})]},proxy:!0},{key:"popup",fn:function(){return[a(m,{attrs:{title:"添加流量限额配置",visible:l.limitPopup,area:60,showFooter:""},on:{"update:visible":function(e){l.limitPopup=e},cancel:l.onCancelLimit,confirm:l.onConfirmLimit}},[a("div",{staticClass:"p-20x"},[a(f,{attrs:{title:"通过设置流量限额，可以限制在特定时间段内允许网络传输的数据量",type:"warning",closable:!1,"show-icon":""}}),a(v,{ref:"flowAlertFormRef",staticClass:"mt-20x",attrs:{"label-position":"right",rules:l.rules,model:l.flowAlertForm}},[a(_,{attrs:{label:"限额"}},[a("div",{staticClass:"flex items-center"},[a(y,{staticClass:"w-[10rem]",model:{value:l.flowAlertForm.type,callback:function(t){e.$set(l.flowAlertForm,"type",t)},expression:"flowAlertForm.type"}},[a(w,{attrs:{value:"total",label:"流量"}}),a(w,{attrs:{value:"request",label:"请求数"}})],1),a(_,{attrs:{prop:"limit_value",label:""}},[a(x,{staticClass:"mx-12x",attrs:{type:"number",width:"10rem"},model:{value:l.flowAlertForm.limit_value,callback:function(t){e.$set(l.flowAlertForm,"limit_value",t)},expression:"flowAlertForm.limit_value"}})],1),"request"===l.flowAlertForm.type?a("span",{staticClass:"text-[#666] text-[1.2rem]"},[e._v("次数")]):e._e(),"total"===l.flowAlertForm.type?a(y,{staticClass:"unit-select w-[8rem]",model:{value:l.flowAlertForm.limit_unit,callback:function(t){e.$set(l.flowAlertForm,"limit_unit",t)},expression:"flowAlertForm.limit_unit"}},[a(w,{attrs:{value:"GB",label:"GB"}}),a(w,{attrs:{value:"MB",label:"MB"}})],1):e._e()],1)]),a(_,{attrs:{label:"类型"}},[a("div",{staticClass:"flex items-center"},[a(b,{on:{change:l.handleRadioChange},model:{value:l.flowAlertForm.rule_type,callback:function(t){e.$set(l.flowAlertForm,"rule_type",t)},expression:"flowAlertForm.rule_type"}},[a(g,{attrs:{label:"moment"}},[e._v("实时"+e._s("total"===l.flowAlertForm.type?"流量":"请求数"))]),a(g,{attrs:{label:"total"}},[e._v("累计"+e._s("total"===l.flowAlertForm.type?"流量":"请求数"))])],1)],1),a("span",{staticClass:"text-[1.2rem] text-[#666]"},[e._v("当前网站运行"+e._s(("moment"===l.flowAlertForm.rule_type?"实时":"累计")+("total"===l.flowAlertForm.type?"流量":"请求数")))])]),a(_,{attrs:{label:"周期"}},[a("div",{staticClass:"flex items-center"},[a(y,{staticClass:"w-[12rem] mr-12x",on:{change:l.handleTimeChange},model:{value:l.flowAlertForm.time_period,callback:function(t){e.$set(l.flowAlertForm,"time_period",t)},expression:"flowAlertForm.time_period"}},["moment"===l.flowAlertForm.rule_type?a(h,e._l(l.momentOptions,(function(e){return a(w,{key:e.value,attrs:{label:e.label,value:e.value}})})),1):e._e(),"total"===l.flowAlertForm.rule_type?a(h,e._l(l.totalOptions,(function(e){return a(w,{key:e.value,attrs:{label:e.label,value:e.value}})})),1):e._e()],1),a("span",{staticClass:"text-[1.2rem] text-[#666]"},[e._v("检测"+e._s(l.timeValue)+"内的"+e._s("moment"===l.flowAlertForm.rule_type?"实时":"累计")+e._s("total"===l.flowAlertForm.type?"流量":"请求情况"))])],1)]),a(_,{attrs:{label:"策略"}},[a("div",{staticClass:"flex items-center"},[a(_,{attrs:{label:"",prop:"threshold_percentage"}},[a(x,{staticClass:"mr-12x",attrs:{textType:"%",type:"number",min:1,width:"12rem"},model:{value:l.flowAlertForm.threshold_percentage,callback:function(t){e.$set(l.flowAlertForm,"threshold_percentage",t)},expression:"flowAlertForm.threshold_percentage"}})],1),a(y,{model:{value:l.flowAlertForm.limit_action,callback:function(t){e.$set(l.flowAlertForm,"limit_action",t)},expression:"flowAlertForm.limit_action"}},[a(w,{attrs:{label:"告警",value:"alert"}}),a(w,{attrs:{label:"告警并停止网站",value:"alert_stop"}})],1)],1),a("span",{staticClass:"text-[1.2rem] text-[#666]"},[e._v("当访问【"+e._s("total"===l.flowAlertForm.type?"流量":"请求次数")+"】超过限额阈值【"+e._s(l.flowAlertForm.threshold_percentage)+"%】时【"+e._s("alert"===l.flowAlertForm.limit_action?"告警":"告警并停止网站")+"】 ")])]),a(_,{attrs:{label:"发送次数",prop:"cycle"}},[a("div",{staticClass:"flex items-center"},[a(x,{attrs:{textType:"次",width:"12rem",type:"number",min:1},model:{value:l.flowAlertForm.cycle,callback:function(t){e.$set(l.flowAlertForm,"cycle",t)},expression:"flowAlertForm.cycle"}}),a("span",{staticClass:"text-[1.2rem] text-[#666] ml-12x"},[e._v("后将不再发送告警信息，如需发送多次请填写2次以上 ")])],1)]),a(_,{attrs:{label:"告警方式"}},[a(u,{attrs:{name:"type"},model:{value:l.flowAlertForm.module,callback:function(t){e.$set(l.flowAlertForm,"module",t)},expression:"flowAlertForm.module"}})],1)],1),a("div",{staticClass:"mt-1.6rem ml-2.4rem"},[a("ul",{staticClass:"list-disc"},[a("li",[e._v("点击安装后状态未更新，尝试点击【"),a(t,[e._v("手动刷新")]),e._v("】")],1)])])],1)])]},proxy:!0}],null,!1,3678081296)})],1)],1)],1)],1)}),[],!1,null,"e01d6db9",null,null).exports;export{z as default};
