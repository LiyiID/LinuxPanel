import{_ as e}from"./index85.js?v=1714377894636";import{_ as t,w as a,x as o}from"./element-lib.js?v=1714377894636";import{n as s,b as r}from"./main.js?v=1714377894636";import{_ as n}from"./index39.js?v=1714377894636";import{_ as p}from"./index58.js?v=1714377894636";import{_ as l}from"./index59.js?v=1714377894636";import{e as i,b as c,f as m,v as u,j as d,H as f,h as v}from"./vue-lib.js?v=1714377894636";import{_}from"./upload.js?v=1714377894636";import{a as h}from"./request-lib.js?v=1714377894636";import{_ as w}from"./index119.js?v=1714377894636";import{e as g}from"./index38.js?v=1714377894636";import{e2 as b,e3 as y,e4 as x,e5 as F,e6 as j}from"./site.store.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./index45.js?v=1714377894636";import"./index62.js?v=1714377894636";import"./check.js?v=1714377894636";const D=s(i({__name:"UploadSpeed",props:{compData:{default:()=>({})}},setup(e){const t=e,a=c(0);return m((()=>t.compData),(e=>{a.value=e.percentum})),{__sfc:!0,props:t,percentum:a}}}),(function(){var e=this,t=e._self._c,a=e._self._setupProxy;return t("div",{staticClass:"download-speed"},[t("div",{staticClass:"download-speed-top"},[t("div",{staticClass:"download-speed-top-title"},[e._v(" "+e._s(e.compData.title)+" ")]),t("div",{staticClass:"download-speed-top-score"},[e._v(e._s(a.percentum)+"%")])]),t(w,{attrs:{strokeWidth:5,percentage:a.percentum,showText:!1}})],1)}),[],!1,null,"d68b3a00",null,null).exports;const k=s(i({__name:"uploadVersionFile",props:{compData:{default:{}}},setup(e,{expose:t}){const a=e,o=window.location.protocol+"//"+window.location.host+"/mod/php/php_async/upload_version",{proxy:s}=d(),r=c(!1),n=[".tar.gz",".gz",".zip"].join(","),p=u({f_size:0,f_path:"/tmp/",f_name:"",f_start:0,ps:a.compData.ps,version:a.compData.version,sitename:a.compData.sitename,blob:""}),l=c([]),i=c(0),m=({file:e,onProgress:t,onSuccess:o,onError:n})=>{const l=new FormData,c=Math.min(e.size,p.f_start+2097152);l.append("f_name",e.name),l.append("f_size",e.size),l.append("f_start",p.f_start.toString()),l.append("ps",a.compData.ps),l.append("version",a.compData.version),l.append("sitename",a.compData.sitename),l.append("blob",e.slice(p.f_start,c)),l.append("f_path",p.f_path);const u=h.CancelToken.source();return i.value||(r.value=!0),i.value=Math.round(p.f_start/e.size*100),h.post("/mod/php/php_async/upload_version",l,{headers:{"Content-Range":"bytes ".concat(p.f_start,"-").concat(e.size,"/"),"x-http-token":window.vite_public_request_token,"Content-Type":"application/x-www-form-urlencoded"},onUploadProgress:e=>{e.event.lengthComputable&&t({percent:Math.round(100*e.loaded/e.total)})},cancelToken:u.token}).then((l=>{"number"==typeof l.data?(p.f_start=l.data,m({file:e,onProgress:t,onSuccess:o,onError:n})):(i.value=0,r.value=!1,s.$message.request(l.data),a.compData.getVersion(),a.compData.close(),o(l.data))})).catch((e=>{i.value=0,r.value=!1,s.$message.error("导入失败"),n(e)})),{abort(){u.cancel("Upload cancelled")}}},f=()=>{s.$refs.upload.submit()},v=()=>{s.$refs.open.$el.click()};return t({onConfirm:f,open:v,fileData:p}),{__sfc:!0,props:a,uploadUrl:o,vm:s,processPopup:r,accept:n,fileData:p,uploadFilesList:l,percentum:i,customUpload:m,uploadChange:(e,t)=>{l.value=t},uploadProgress:(e,t,a)=>{p.f_start=e.percent,l.value=a.map((a=>(a.uid===t.uid&&(a.percentage=e.percent),a)))},onConfirm:f,open:v,uploadSpeed:D}}}),(function(){var e=this._self._c,a=this._self._setupProxy;return e("div",[e(_,{ref:"upload",staticClass:"upload-demo",attrs:{"show-file-list":!1,name:"blob",accept:a.accept,action:a.uploadUrl,"auto-upload":!0,multiple:!1,"file-list":a.uploadFilesList,"on-progress":a.uploadProgress,"on-change":a.uploadChange,"http-request":a.customUpload}},[e(t,{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],ref:"open",attrs:{size:"small",type:"primary"}}),e(t,{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticStyle:{"margin-left":"10px"},attrs:{size:"small",type:"success"},on:{click:a.onConfirm}})],1),e(r,{attrs:{title:!1,visible:a.processPopup,area:40}},[e("div",{staticClass:"p-2rem"},[e(a.uploadSpeed,{attrs:{compData:{title:"正在上传文件，请稍后...",percentum:a.percentum}}})],1)])],1)}),[],!1,null,null,null,null).exports;const C=s(i({__name:"index",props:{compData:{default:{}}},setup(e){const t=e,{proxy:a}=d(),o=c([]),s=c(!1),r=c(!1),n=c(),p=u({name:"",version:"",ps:""}),l=c(!1),i=c(),m=u({version:""}),_=[{content:"添加版本",active:!0,event:()=>{p.ps="",p.version="",r.value=!0}},{content:"当前目录生成版本",event:()=>{m.version="",l.value=!0}}],h=async e=>{try{await a.$confirm({title:"删除版本【".concat(e.version,"】"),useHtml:!1,message:"删除版本，是否继续操作？",icon:"warning"});const o=await b({sitename:t.compData.name,version:e.version});a.$message.request(o),o.status&&P()}catch(o){}},w=async e=>{let o;try{await a.$confirm({title:"恢复版本【".concat(e.version,"】"),useHtml:!1,message:"恢复版本，会删除目录下所有文件，请将当前目录打包文件后继续操作？",type:"calc",icon:"warning"}),o=a.$load("正在恢复版本，请稍后...");const{data:s}=await y({sitename:t.compData.name,version:e.version});a.$message.request(s)}catch(s){}finally{o.close()}},D=async e=>{try{const o=await x({sitename:t.compData.name,version:e.version,ps:e.ps});a.$message.request(o),P()}catch(o){}},C=c([{label:"版本号",prop:"version"},{label:"备注",prop:"ps",minWidth:120,isCustom:!0,showOverflowTooltip:!1,render:e=>{var t;const a={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return e.ps=null==(t=e.ps)?void 0:t.replace(/&(lt|gt|nbsp|amp|quot);/gi,(function(e,t){return a[t]})),f("input",{attrs:{type:"text",placeholder:"点击编辑备注"},domProps:{value:e.ps},class:"bt-table-input w-full !whitespace-pre-line",on:{blur:t=>{if(e.ps===t.target.value)return!1;e.ps=t.target.value,D(e)}}})}},g([{onClick:w,title:"恢复"},{onClick:h,title:"删除"}])]),P=async()=>{s.value=!0;try{const{data:e}=await F({sitename:t.compData.name});o.value=e,s.value=!1}catch(e){}};return v((()=>{P()})),{__sfc:!0,props:t,vm:a,tableData:o,tableLoading:s,addPopup:r,addFromRef:n,addFrom:p,addRules:{version:[{required:!0,message:"请输入版本号",trigger:"blur"}]},nowPopup:l,nowFromRef:i,nowFrom:m,tableBtnGroup:_,deleteVersion:h,recoverVersion:w,setPsEvent:D,tableColumns:C,getVersion:P,nowFileBackupEvent:async()=>{let e;try{e=a.$load("正在生成版本，请稍后...");const o=await j({sitename:t.compData.name,version:m.version});a.$message.request(o),o.status&&(l.value=!1,P())}catch(o){}finally{e.close()}},selectFile:()=>{n.value.validate((e=>{e&&a.$refs.fileIpRef.open()}))},changeInputFile:async e=>{},uploadVersionFile:k}}}),(function(){var t=this,s=t._self._c,i=t._self._setupProxy;return s("div",[s(l,{scopedSlots:t._u([{key:"header-left",fn:function(){return[s(p,{attrs:{group:i.tableBtnGroup}})]},proxy:!0},{key:"header-right",fn:function(){},proxy:!0},{key:"content",fn:function(){return[s(n,{directives:[{name:"loading",rawName:"v-loading",value:i.tableLoading,expression:"tableLoading"}],attrs:{"max-height":"500",column:i.tableColumns,data:i.tableData}})]},proxy:!0},{key:"footer-left",fn:function(){},proxy:!0},{key:"footer-right",fn:function(){},proxy:!0},{key:"popup",fn:function(){return[s(r,{attrs:{title:"添加版本",area:44,visible:i.addPopup,"show-footer":"",confirmText:"上传文件"},on:{"update:visible":function(e){i.addPopup=e},confirm:i.selectFile}},[s(a,{ref:"addFromRef",staticClass:"p-2rem",attrs:{model:i.addFrom,rules:i.addRules}},[s(o,{attrs:{label:"版本号",prop:"version"}},[s(e,{attrs:{placeholder:"请输入版本号"},model:{value:i.addFrom.version,callback:function(e){t.$set(i.addFrom,"version",e)},expression:"addFrom.version"}})],1),s(o,{attrs:{label:"备注",prop:"ps"}},[s(e,{attrs:{placeholder:"请输入备注"},model:{value:i.addFrom.ps,callback:function(e){t.$set(i.addFrom,"ps",e)},expression:"addFrom.ps"}})],1),s(i.uploadVersionFile,{ref:"fileIpRef",attrs:{compData:{...i.addFrom,sitename:t.compData.name,getVersion:i.getVersion,close:()=>{i.addPopup=!1}}},on:{"upload-success":i.changeInputFile}})],1)],1),s(r,{attrs:{title:"当前目录生成版本",area:44,visible:i.nowPopup,"show-footer":""},on:{"update:visible":function(e){i.nowPopup=e},confirm:i.nowFileBackupEvent}},[s(a,{ref:"nowFromRef",staticClass:"p-2rem",attrs:{model:i.nowFrom,rules:i.addRules}},[s(o,{attrs:{label:"版本号",prop:"version"}},[s(e,{attrs:{placeholder:"请输入版本号"},model:{value:i.nowFrom.version,callback:function(e){t.$set(i.nowFrom,"version",e)},expression:"nowFrom.version"}})],1)],1)],1)]},proxy:!0}])})],1)}),[],!1,null,null,null,null).exports;export{C as default};
