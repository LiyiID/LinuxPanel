import{_ as e}from"./index39.js?v=1714377894636";import{c as a,f as t,J as s,n as l,q as r,b as i,F as o,a as n}from"./main.js?v=1714377894636";import{_ as d}from"./index40.js?v=1714377894636";import{a9 as m,w as c,x as u,q as p,s as h,y as g,ab as f}from"./element-lib.js?v=1714377894636";import{_ as v}from"./index85.js?v=1714377894636";import"./radio-button.js?v=1714377894636";import{_ as b}from"./index52.js?v=1714377894636";import{_ as y}from"./index55.js?v=1714377894636";import{_}from"./index59.js?v=1714377894636";import{e as x,b as F,v as T,H as k,h as w,j}from"./vue-lib.js?v=1714377894636";import{_ as C}from"./index46.js?v=1714377894636";import{a as D}from"./confirm.js?v=1714377894636";import{o as $}from"./software2.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import{e as P}from"./index38.js?v=1714377894636";import{df as z,cQ as q,dg as R,dh as A,di as E,dj as L,dk as O,dl as S,i as N}from"./site.store.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./config.js?v=1714377894636";import"./index.vue_vue_type_style_index_0_lang.js?v=1714377894636";import"./index45.js?v=1714377894636";import"./check.js?v=1714377894636";const B=l(x({__name:"DialingTestAlarm",props:{compData:{default:{}}},setup(e){const l=e,{proxy:r}=j(),i=F([]),o=F(!1),n=F(null),d=F(!1),m=T({url:"",channel:[],name:"",cycle:10,method:"",alarm_count:5,address:"localhost",methodData:""}),c=T({p:1,limit:10,total:0}),u=F([]),p=F([]),h=F([{label:"ISP",prop:"isp"},{label:"解析IP",prop:"primary_ip"},{label:"状态",prop:"http_code"},{label:"总耗时",prop:"total_time",render:e=>b(1e3,500,e.total_time,"ms")},{label:"解析耗时",prop:"namelookup_time",render:e=>b(500,100,e.namelookup_time,"ms")},{label:"连接耗时",prop:"connect_time",render:e=>b(500,100,e.connect_time,"ms")},{label:"处理耗时",prop:"starttransfer_time",render:e=>b(1e3,500,e.starttransfer_time,"ms")},{label:"响应大小",prop:"size_download",render:e=>a(e.size_download)},{label:"传输速度",prop:"speed_download",render:e=>a(e.speed_download)},{label:"响应头",prop:"header",width:280,render:e=>k(v,{attrs:{type:"textarea",readOnly:!0,rows:6,value:e.header},class:"!w-full"})}]),g=F([]),f=F(!1),b=(e,a,t,s)=>{var l="";return t>e?l="text-[#FF5722]":t>a&&(l="text-[#FFB800]"),k("span",{class:l},[t.toFixed(2)+s])},y=async()=>{var e;o.value=!0;try{const a=await z();p.value=[],Object.keys(a.data).forEach((e=>{p.value.push({id:e,name:a.data[e]})})),p.value=null==(e=p.value)?void 0:e.filter((e=>"sensitive"!==e.id&&"similarity"!==e.id)),m.method="status_code"}catch(a){}o.value=!1},_=async()=>{var e,a;o.value=!0;try{const t=await q({table:"domain",list:"True",search:l.compData.id});u.value=[],null==(e=t.data)||e.forEach((e=>{u.value.push({name:"http://"+e.name,id:e.id}),u.value.push({name:"https://"+e.name,id:e.id})})),m.url=null==(a=u.value[0])?void 0:a.name}catch(t){}o.value=!1},x=async()=>{o.value=!0;try{const e=await R({sid:l.compData.id,p:c.p,row:c.limit});i.value=e.data.data,c.total=s(e.data.page.page),c.limit=Number(e.data.row)}catch(e){}o.value=!1},B=async e=>{let a=r.$load("正在执行,请稍候...");try{const a=await L({id:e.id});a.status?(f.value=!0,g.value=a.data,x()):r.$message.request(a)}catch(t){}finally{a.close()}},H=async e=>{let a=r.$load("正在删除,请稍候...");try{const a=await O({id:e.id,action:"del"});r.$message.request(a),await x()}catch(t){}finally{a.close()}},I=async e=>{let a=r.$load("正在获取日志,请稍候...");try{(await S({id:e.id,p:1})).data.length||r.$message.success("暂无日志")}catch(t){}finally{a.close()}},M=async()=>{try{const{data:e}=await N({sName:"bt_boce"});return!!e.status||(await $({name:"bt_boce",softData:e}),!1)}catch(e){}},V=()=>{d.value=!1,r.$refs.boceFormRef.resetFields(),r.$refs.boceFormRef.clearValidate()},J=async e=>{D({confirm:{icon:"warning",title:e.status?"停用拨测告警":"启用拨测告警",width:"40rem",iconColor:"#E6A23C",message:e.status?"停用后,检测到问题时将不会发送告警通知，是否继续？":"启用后,检测到问题时将会发送告警通知，是否继续？"},loading:"正在设置，请稍后...",request:async()=>await A({id:e.id,status:e.status?0:1}),complete:x})},Q=F([{label:"任务名称",prop:"name"},{label:"监控频率",render:e=>"".concat(e.cycle,"分钟")},{label:"触发条件",prop:"trigger_condition"},{label:"最后执行时间",width:136,render:e=>t(e.last_run_time)||"--"},{label:"状态\t",prop:"method",width:40,render:e=>k(C,{attrs:{value:!!e.status,size:"mini"},on:{change:()=>J(e)}})},P([{onClick:B,title:"执行"},{onClick:e=>{var a;d.value=!0,m.id=e.id,m.name=e.name,m.url=e.url,m.cycle=e.cycle,m.method=e.status_code?"status_code":e.size?"size":e.delay?"delay":"keyword",m.methodData=e.delay||e.size||e.keyword||e.status_code,m.channel=null==(a=e.channel)?void 0:a.split(",")},title:"编辑"},{onClick:I,title:"日志"},{onClick:H,title:"删除"}])]);return w((()=>{x(),y()})),{__sfc:!0,vm:r,props:l,tableData:i,tableLoading:o,pushCheckBoxRef:n,dialingTestPopup:d,dialingTestForm:m,tableParams:c,domainOptions:u,typeOptions:p,resultColumn:h,resultData:g,resultPopup:f,rules:{name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],cycle:[{required:!0,message:"请输入监控频率",trigger:"blur"}],alarm_count:[{required:!0,message:"请输入告警次数",trigger:"blur"}],channel:[{required:!0,message:"请选择告警方式",trigger:"blur"}],methodData:[{required:!0,message:"请输入告警条件",trigger:["blur","change"]}]},set_time_limit:b,addAlert:async()=>{var e,a,t;await _(),delete m.id,m.name="".concat(null==(a=null==(e=p.value)?void 0:e.find((e=>"status_code"===e.id)))?void 0:a.name," 【").concat(null==(t=u.value[0])?void 0:t.name,"】"),d.value=!0},getAlarmOption:y,getDomain:_,getAlarmListEvent:x,onConfirm:async()=>m.channel.length?"delay"!==m.method&&"keyword"!==m.method||""!==m.methodData?void r.$refs.boceFormRef.validate((async e=>{if(!e)return;let a=r.$load("正在提交,请稍候...");try{let e,a={...m,channel:m.channel.join(",")};"delay"===m.method&&(a.delay=m.methodData),"keyword"===m.method&&(a.keyword=m.methodData),"size"===m.method&&(a.size=1),"status_code"===m.method&&(a.status_code=1),delete a.methodData,e=m.id?await A(a):await E(a),e.status?r.$message.success(e.msg):r.$message.error({msg:e.msg,time:5e3}),x(),V()}catch(t){}finally{a.close()}})):r.$message.error("请输入告警条件"):r.$message.error("请选择告警方式"),startTaskEvent:B,deleteDataEvent:H,getLogs:I,handleChangeMethod:async e=>{if(m.address="localhost","node"===e){await M()&&(m.address="node")}},handleChangeType:e=>{r.$nextTick((()=>{var a,t;r.$refs.boceFormRef.clearValidate("methodData"),m.methodData="status_code"===e||"size"===e?"1":"",m.name="".concat(null==(t=null==(a=p.value)?void 0:a.find((a=>a.id===e)))?void 0:t.name," 【").concat(m.url,"】")}))},getPluginState:M,cancelForm:V,handleChangeStatus:J,changePage:e=>{c.p=e,x()},changeSize:e=>{c.limit=e,x()},handleChangeName:e=>{var a;m.name="".concat(null==(a=p.value[0])?void 0:a.name," 【").concat(e,"】")},refreshPushForm:()=>{n.value.renderPushConfig()},tableColumns:Q}}}),(function(){var a=this,t=a._self._c,s=a._self._setupProxy;return t("div",[t(_,{scopedSlots:a._u([{key:"header-left",fn:function(){return[t(r,{on:{click:s.addAlert}},[a._v("添加拨测告警")])]},proxy:!0},{key:"header-right",fn:function(){return[t(y,{attrs:{refresh:s.getAlarmListEvent}})]},proxy:!0},{key:"content",fn:function(){return[t(e,{directives:[{name:"loading",rawName:"v-loading",value:s.tableLoading,expression:"tableLoading"}],attrs:{column:s.tableColumns,data:s.tableData}})]},proxy:!0},{key:"footer-left",fn:function(){},proxy:!0},{key:"footer-right",fn:function(){return[t(b,{attrs:{total:s.tableParams.total,"current-page":s.tableParams.p,"page-size":s.tableParams.limit},on:{"current-change":s.changePage,"size-change":s.changeSize}})]},proxy:!0},{key:"popup",fn:function(){return[t(i,{attrs:{title:"拨测告警",visible:s.dialingTestPopup,area:54,showFooter:""},on:{"update:visible":function(e){s.dialingTestPopup=e},cancel:s.cancelForm,confirm:s.onConfirm}},[t("div",{staticClass:"p-20x"},[t(m,{attrs:{type:"success",closable:!1},scopedSlots:a._u([{key:"title",fn:function(){return[t("div",{staticClass:"text-[#666] text-[1.2rem] py-8x"},[t("div",{staticClass:"mb-8x"},[t("b",[a._v("本地测试")]),a._v("：本机发送请求，可能导致测试结果不准确等结果 ")]),t("div",[t("b",[a._v("多节点测试")]),a._v("（推荐）：通过宝塔部署在全国的多个节点上来实现更全面的覆盖和测试 ")])])]},proxy:!0}])}),t(c,{ref:"boceFormRef",staticClass:"mt-16x",attrs:{"label-position":"right",model:s.dialingTestForm,rules:s.rules}},[t(u,{attrs:{label:"监控网站URL",prop:"url"}},[t(p,{staticClass:"w-[32rem]",on:{change:s.handleChangeName},model:{value:s.dialingTestForm.url,callback:function(e){a.$set(s.dialingTestForm,"url",e)},expression:"dialingTestForm.url"}},a._l(s.domainOptions,(function(e,a){return t(h,{key:a,attrs:{label:e.name,value:e.name}})})),1)],1),t(u,{attrs:{label:"任务名称",prop:"name"}},[t(v,{attrs:{width:"32rem"},model:{value:s.dialingTestForm.name,callback:function(e){a.$set(s.dialingTestForm,"name",e)},expression:"dialingTestForm.name"}})],1),t(u,{attrs:{label:"检测节点",prop:"address"}},[t(g,{attrs:{size:"small"},on:{change:s.handleChangeMethod},model:{value:s.dialingTestForm.address,callback:function(e){a.$set(s.dialingTestForm,"address",e)},expression:"dialingTestForm.address"}},[t(f,{attrs:{label:"localhost",disabled:!!s.dialingTestForm.id}},[a._v("本地测试")]),t(f,{attrs:{label:"node",disabled:!!s.dialingTestForm.id}},[t("div",{staticClass:"flex items-center justify-center h-[3.2rem]"},[t(o,{staticClass:"mr-4x mt-2x",attrs:{name:"icon-ltd",size:"1.8"}}),a._v(" 多节点测试 ")],1)])],1)],1),t(u,{attrs:{label:"监控频率",prop:"cycle"}},[t(v,{attrs:{"text-type":"分钟",type:"number",min:10},model:{value:s.dialingTestForm.cycle,callback:function(e){a.$set(s.dialingTestForm,"cycle",e)},expression:"dialingTestForm.cycle"}})],1),t(u,{attrs:{label:"告警类型",prop:"method"}},[t(p,{staticClass:"w-[32rem]",attrs:{disabled:!!s.dialingTestForm.id},on:{change:s.handleChangeType},model:{value:s.dialingTestForm.method,callback:function(e){a.$set(s.dialingTestForm,"method",e)},expression:"dialingTestForm.method"}},a._l(s.typeOptions,(function(e,a){return t(h,{key:a,attrs:{label:e.name,value:e.id}})})),1)],1),"delay"===s.dialingTestForm.method||"keyword"===s.dialingTestForm.method?t(u,{attrs:{label:" ",prop:"methodData"}},[t("div",{staticClass:"flex items-center"},[t("span",{staticClass:"inline-block text-[#666] text-[1.2rem] mr-4x"},[a._v(" "+a._s("delay"===s.dialingTestForm.method?"平均响应延迟大于":"当响应内容不包含")+" ")]),t(v,{attrs:{disabled:!!s.dialingTestForm.id,width:"18rem",placeholder:"请输入关键词,分割",remarks:"delay"===s.dialingTestForm.method?"ms":"内容,触发告警"},model:{value:s.dialingTestForm.methodData,callback:function(e){a.$set(s.dialingTestForm,"methodData",e)},expression:"dialingTestForm.methodData"}})],1)]):a._e(),"size"===s.dialingTestForm.method||"status_code"===s.dialingTestForm.method?t(u,{attrs:{label:" "}},["size"===s.dialingTestForm.method?t("span",{staticClass:"inline-block text-[#666] text-[1.2rem] mr-4x"},[a._v("网站大小变化告警 当网站响应内容大小发生变化达到20%时，将触发告警")]):a._e(),"status_code"===s.dialingTestForm.method?t("span",{staticClass:"inline-block text-[#666] text-[1.2rem] mr-4x"},[a._v("当网站响应状态不为正常状态(200、300、302)，将触发告警")]):a._e()]):a._e(),t(u,{attrs:{label:"告警次数",prop:"alarm_count"}},[t("div",{staticClass:"flex items-center"},[t("span",{staticClass:"inline-block text-[#666] text-[1.2rem] mr-4x"},[a._v("每日最多触发")]),t(v,{attrs:{remarks:"次告警",width:"12rem",type:"number",min:1},model:{value:s.dialingTestForm.alarm_count,callback:function(e){a.$set(s.dialingTestForm,"alarm_count",e)},expression:"dialingTestForm.alarm_count"}})],1)]),t(u,{attrs:{label:"告警方式",prop:"channel"}},[t(d,{ref:"pushCheckBoxRef",model:{value:s.dialingTestForm.channel,callback:function(e){a.$set(s.dialingTestForm,"channel",e)},expression:"dialingTestForm.channel"}})],1)],1),t("ul",{staticClass:"mt-20x list-disc ml-20x"},[t("li",[a._v(" 点击配置后状态未更新，尝试点击【 "),t(n,{on:{click:s.refreshPushForm}},[a._v("手动刷新")]),a._v(" 】 ")],1)])],1)]),t(i,{attrs:{title:"查看扫描拨测结果-"+a.compData.name,visible:s.resultPopup,area:120},on:{"update:visible":function(e){s.resultPopup=e}}},[t("div",{staticClass:"p-20x"},[t(e,{attrs:{column:s.resultColumn,data:s.resultData}})],1)])]},proxy:!0}])})],1)}),[],!1,null,"ba64df28",null,null).exports;export{B as default};
