import{_ as e}from"./index118.js?v=1714377894636";import{k as s,n as t,a,q as l}from"./main.js?v=1714377894636";import{o as n}from"./element-lib.js?v=1714377894636";import{_ as i}from"./index46.js?v=1714377894636";import{e as r,b as o,f as c,c as p,S as u,h as m,j as v}from"./vue-lib.js?v=1714377894636";import{a5 as f,a8 as d,ab as y}from"./site.popup.js?v=1714377894636";import{g as _,em as x,en as C,cs as w,eo as h,ep as j,eq as b,er as I}from"./site.store.js?v=1714377894636";import{e as S}from"./soft.api.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./index.vue_vue_type_style_index_0_lang.js?v=1714377894636";import"./index38.js?v=1714377894636";import"./index45.js?v=1714377894636";import"./element-ui.common.js?v=1714377894636";import"./date-util.js?v=1714377894636";import"./vdom.js?v=1714377894636";import"./index62.js?v=1714377894636";import"./cascader-panel.js?v=1714377894636";import"./check.js?v=1714377894636";const g=t(r({__name:"CurrentCertInfo",setup(e){const{proxy:t}=v(),{refs:{siteInfo:a,sslInfo:l,sslTabsActive:n},renewalCert:i,closeCert:r,getSslInfoConfig:g,renewalLetCert:k}=_(),T=o(l.value.key),L=o(l.value.csr),$=o([{content:'粘贴您的*.key以及*.pem内容，然后保存即可<a href="http://www.bt.cn/bbs/thread-704-1-1.html" class="text-primary" target="_blank">[帮助]</a>。',useHtml:!0},{text:"如果浏览器提示证书链不完整,请检查是否正确拼接PEM证书"},{text:"PEM格式证书 = 域名证书.crt + 根证书(root_bundle).crt"},{text:"在未指定SSL默认站点时,未开启SSL的站点使用HTTPS会直接访问到已开启SSL的站点"},{text:"如开启后无法使用HTTPS访问，请检查安全组是否正确放行443端口"}]),E=["其他证书","Let's Encrypt","宝塔SSL","商业证书"];c((()=>l.value),(()=>{T.value=l.value.key,L.value=l.value.csr}),{deep:!0});const H=p((()=>-1!==l.value.type?E[l.value.type]:E[0])),A=async()=>{let e;try{e=t.$load("正在获取证书到期配置，请稍后...");const s=await S();let l=[],n={};l=Object.values(s.data.site_push).filter((e=>"ssl"===e.type)),l.forEach((e=>{e.project===a.value.name&&(n=e),"all"!==e.project||Object.keys(n).length||(n=e)})),y(n)}finally{e&&e.close()}},P=u("mountEvent");let q=!0;return m((()=>{q?q=!1:P()})),{__sfc:!0,vm:t,siteInfo:a,sslInfo:l,sslTabsActive:n,renewalCert:i,closeCert:r,getSslInfoConfig:g,renewalLetCert:k,certKey:T,certCsr:L,sslHelp:$,typeList:E,sslTypeInfo:H,saveAndEnableCert:async()=>{let e;try{let s=!1;if(!T.value&&!L.value)return t.$message.error("请填写完整的证书内容");T.value===l.value.key&&L.value===l.value.csr||(s=!0,await t.$confirm({title:"证书保存提示",message:"当前证书内容发生改变，证书信息将同步更新，继续操作？",icon:"warning"})),e=t.$load("正在保存证书信息，请稍后...");const{data:n}="proxy"==a.value.project_type||"nginx"==a.value.project_type?await x({site_name:a.value.name,key:T.value,csr:L.value}):await C({type:s?0:l.value.type,siteName:a.value.name,key:T.value,csr:L.value});t.$message.request(n),await g()}finally{e&&e.close()}},renewalCurrentCert:async()=>{if(3===l.value.type)i(l.value.oid,l.value.type);else if(32===l.value.length&&-1===l.value.indexOf("/")){const e=await f();k(l.value.index),e.close()}else{const{data:e}=await w({siteName:a.value.name,pem_file:l.value.index});d(e)}},downloadCertMethod:async()=>{let e;try{e=t.$load("正在下载证书，请稍后...");const{data:s}=await h({siteName:a.value.name,pem:L.value,key:T.value});s.status&&window.open("/download?filename="+encodeURIComponent(s.msg))}finally{e&&e.close()}},forceHttpsChange:async e=>{let s;try{if(e||await t.$confirm({title:"关闭强制HTTPS",message:"关闭强制HTTPS后需要清空浏览器缓存才能生效,是否继续操作?",icon:"warning"}),s=t.$load("正在"+(e?"开启":"关闭")+"强制HTTPS，请稍后..."),"proxy"==a.value.project_type||"nginx"==a.value.project_type){const{data:s}=await j({site_name:a.value.name,force_https:e?1:0});return t.$message.request(s),void(await g())}const{data:l}=e?await b({siteName:a.value.name}):await I({siteName:a.value.name});t.$message.request(l),await g()}catch(n){l.value.https=!e}finally{s&&s.close()}},cutSslType:e=>{switch(e){case 3:n.value="busSslList";break;case 2:n.value="trustAsiaList";break;case 1:n.value="letsEncryptList";break;case 0:n.value="currentCertInfo";break;default:n.value="certFolderList"}},setSslExpire:A,cutSslExpire:async e=>{let a;if(e)A();else try{await t.$confirm({title:"关闭证书到期提醒",message:"关闭证书到期提醒后将不再提醒证书到期，是否继续操作？",icon:"warning"}),a=t.$load("正在关闭证书到期提醒，请稍后...");const{id:e,cycle:n,push_count:i,interval:r,module:o,project:c}=l.value.push,{data:p}=await s({name:"site_push",id:e,data:JSON.stringify({status:!1,type:"ssl",project:c,cycle:n,title:"网站SSL到期提醒",module:o,interval:r,push_count:parseInt("".concat(i))})});t.$message.request(p)}catch(n){"cancel"===n&&(l.value.pushAlarm=!e)}finally{a&&a.close()}},refresh:P,firstLoad:q}}}),(function(){var s=this,t=s._self._c,r=s._self._setupProxy;return t("div",{staticClass:"flex flex-col w-full pt-16x overflow-y-hidden"},[r.sslInfo.certInfo?t("div",{staticClass:"ssl-status-info"},[t("div",{staticClass:"left flex-1"},[t("div",[t("span",[s._v("证书分类：")]),t("span",[t(a,{on:{click:function(e){return r.cutSslType(r.sslInfo.type)}}},[s._v(" "+s._s(r.sslTypeInfo)+" ")])],1)]),t("div",[t("span",[s._v("认证域名：")]),t("span",{staticClass:"truncate max-w-24rem",attrs:{title:r.sslInfo.dns.join("、")}},[s._v(s._s(r.sslInfo.dns.join("、")))])]),t("div",{staticClass:"!mb-0"},[t("span",[s._v("强制HTTPS： ")]),t("span",[t(i,{staticClass:"!mb-0",attrs:{size:"mini"},on:{change:r.forceHttpsChange},model:{value:r.sslInfo.https,callback:function(e){s.$set(r.sslInfo,"https",e)},expression:"sslInfo.https"}})],1)])]),t("div",{staticClass:"right flex-1"},[t("div",[t("span",[s._v("证书品牌：")]),t("span",{staticClass:"truncate max-w-24rem",attrs:{title:r.sslInfo.issuer}},[s._v(s._s(r.sslInfo.issuer))])]),t("div",[t("span",[s._v("到期时间：")]),t("span",[s._v(" "+s._s(r.sslInfo.endtime>0?r.sslInfo.notAfter:"")+" "),t("span",{directives:[{name:"show",rawName:"v-show",value:r.sslInfo.endtime<0,expression:"sslInfo.endtime < 0"}],staticClass:"text-danger"},[s._v("证书已过期")])])]),t("div",{staticClass:"!mb-0"},[t("span",[s._v("到期提醒：")]),t("span",{staticClass:"flex items-center"},[t(i,{staticClass:"!mb-0",attrs:{size:"mini"},on:{change:r.cutSslExpire},model:{value:r.sslInfo.pushAlarm,callback:function(e){s.$set(r.sslInfo,"pushAlarm",e)},expression:"sslInfo.pushAlarm"}}),t(a,{staticClass:"ml-8x",on:{click:function(e){return r.setSslExpire()}}},[s._v("到期设置提醒")])],1)])])]):s._e(),t("div",{staticClass:"flex flex-1 justify-start"},[t("div",{staticClass:"flex-1 mr-20x"},[t("div",{staticClass:"mb-4x"},[s._v("密钥(KEY)")]),t(n,{attrs:{type:"textarea",rows:"12"},model:{value:r.certKey,callback:function(e){r.certKey=e},expression:"certKey"}})],1),t("div",{staticClass:"flex-1"},[t("div",{staticClass:"mb-4x"},[s._v("证书(PEM格式)")]),t(n,{attrs:{type:"textarea",rows:"12"},model:{value:r.certCsr,callback:function(e){r.certCsr=e},expression:"certCsr"}})],1)]),t("div",{staticClass:"my-16x"},[t(l,{staticClass:"mr-4x",on:{click:r.saveAndEnableCert}},[s._v(" "+s._s(r.sslInfo.isStart?"保存":"保存并启用证书")+" ")]),r.sslInfo.isSupportRenewal||1===r.sslInfo.type?t(l,{staticClass:"mr-4x",on:{click:r.renewalCurrentCert}},[s._v(" 续签证书 ")]):s._e(),r.sslInfo.csr?t(l,{staticClass:"mr-4x",attrs:{type:"default"},on:{click:r.downloadCertMethod}},[s._v(" 下载证书 ")]):s._e(),r.sslInfo.isStart?t(l,{attrs:{type:"default"},on:{click:r.closeCert}},[s._v("关闭SSL")]):s._e()],1),t(e,{staticClass:"ml-20x",attrs:{list:r.sslHelp,listStyle:"disc"}})],1)}),[],!1,null,"9aaead19",null,null).exports;export{g as default};
