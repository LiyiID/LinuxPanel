import{g as e,o as a,p as t,aS as s,n as l,a as i,D as r,F as o,r as n,q as c,b as u}from"./main.js?v=1714377894636";import m from"./WebLogAnalysis.js?v=1714377894636";import{u as v,F as p,w as d,x as h}from"./element-lib.js?v=1714377894636";import{_ as g}from"./index135.js?v=1714377894636";import{_ as f}from"./index40.js?v=1714377894636";import{_ as y}from"./index85.js?v=1714377894636";import{_ as x}from"./index46.js?v=1714377894636";import{_ as b}from"./index77.js?v=1714377894636";import{e as _,b as w,v as j,f as k,h as C,i as L,j as D}from"./vue-lib.js?v=1714377894636";import{g as P,d8 as I,d9 as T,da as S,db as F,dc as N,dd as z,de as $}from"./site.store.js?v=1714377894636";import{a as E}from"./confirm.js?v=1714377894636";import{c as R}from"./check.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./index118.js?v=1714377894636";import"./index52.js?v=1714377894636";import"./index39.js?v=1714377894636";import"./index59.js?v=1714377894636";import"./logs.table.js?v=1714377894636";import"./config.js?v=1714377894636";import"./index.vue_vue_type_style_index_0_lang.js?v=1714377894636";import"./index42.js?v=1714377894636";const A=l(_({__name:"SiteLogs",props:{compData:{default:{}}},setup(l){const i=l,{refs:{authType:r}}=e(),{refs:{refreshData:o,siteTabActiveList:n,siteInfo:c}}=P(),{proxy:u}=D(),m=w(100),v=w(""),p=w(i.compData.tabName||"response"),d=w(!1),h=j({alert:!1,showIp:!1,logs:"",size:"0 b"}),g=w(!1),f=w(!1),y=w(!1),x=w(!1),b=j({logs:"",size:"0 b"}),_=w(!1),A=j({cycle:0,keys:"",channel:[]}),q=w(""),V=w({}),B=w(Number(o.value.time)),H=w(),J=async()=>{x.value=!0;try{const e=await I();h.showIp=1===e.data.value}catch(e){}finally{x.value=!1}},O=async()=>{x.value=!0;try{const e=await T({sitename:c.value.name});h.alert=e.data.status,A.cycle=e.data.config.cycle,A.keys=e.data.config.keys.join(","),A.channel=e.data.config.channel.split(","),V.value=Object.assign({},A)}catch(e){}finally{x.value=!1}},W=async()=>{var e;"ltd"!==r.value&&(h.showIp=!1),y.value=!0;try{let a;"proxy"===v.value?(a=await S({site_name:c.value.name,type:"access"}),h.size=(null==(e=a.data)?void 0:e.size)||"0 b"):a=await F({siteName:c.value.name,ip_area:h.showIp?1:0}),h.logs=a.data.msg||"暂无日志信息"}catch(a){}finally{y.value=!1}},G=async()=>{var e,a;y.value=!0;try{let t;"proxy"===v.value?(t=await S({site_name:c.value.name,type:"error"}),b.size=(null==(e=t.data)?void 0:e.size)||"0 b"):t=await z({siteName:c.value.name}),b.logs=(null==(a=t.data)?void 0:a.msg)||t.msg||"暂无日志信息"}catch(t){}finally{y.value=!1}};k((()=>c.value),(e=>{var a,t,s;(null==(t=null==(a=c.value)?void 0:a.project_config)?void 0:t.bind_extranet)&&(d.value=!!(null==(s=c.value.project_config)?void 0:s.bind_extranet))}),{immediate:!0});const K=w(["php","proxy","html","nginx"]),M=async()=>{var e,a,t,s;d.value=!!(null==(a=null==(e=c.value)?void 0:e.project_config)?void 0:a.bind_extranet),(null==(s=null==(t=c.value)?void 0:t.project_config)?void 0:s.bind_extranet)&&(y.value=!0,x.value=!0,await J(),"python"!==v.value&&await O(),await W()),K.value.includes(v.value)&&(d.value=!0,"php"===v.value&&(await J(),await O()),await W())},Q=async()=>{var e;const a=R(null==(e=c.value)?void 0:e.project_type,"string","");let t=null==a?void 0:a.toLowerCase();"node"===t&&(t="nodejs"),v.value=t,M(),o.value.status&&(o.value.timer=setInterval((()=>{W()}),1e3*o.value.time))};return C((async()=>{"ltd"!==r.value&&(h.showIp=!1),Q()})),L((()=>{clearInterval(o.value.timer),clearInterval(H.value)})),{__sfc:!0,props:i,authType:r,refreshData:o,siteTabActiveList:n,siteInfo:c,vm:u,percentage:m,siteType:v,tabActive:p,isBindExtranet:d,responseLogData:h,visible:g,pathPopover:f,logLoading:y,dataLoading:x,errorLogData:b,alertPopup:_,alertSetForm:A,logsPathValue:q,alertResData:V,refreshNum:B,refreshPercent:H,getIpStatus:J,getAlertStatus:O,format:e=>B,getLogs:W,changeIpShow:async e=>{"ltd"!==r.value?(h.showIp=!1,t({disablePro:!0,sourceId:184})):W()},jumpPath:()=>{n.value.moduleSettingsAct="mapping",n.value.isJump=!0},setPushTaskEvent:async e=>{let a={sitename:c.value.name};if("switch"!==e){if(""===A.keys)return u.$message.error("关键字不能为空");if(0===A.channel.length)return u.$message.error("请选择告警方式");delete a.sitename,a.channel=A.channel.join(","),a.cycle=A.cycle,a.keys=JSON.stringify(A.keys.split(","))}let t=u.$load("正在处理中,请稍后...");try{const t=await N(a);u.$message.request(t),"switch"===e&&h.alert?_.value=!0:"confirm"!==e&&h.alert||(_.value=!1),O()}catch(s){}finally{t.close()}},cancelPopup:()=>{_.value=!1,A.cycle=V.value.cycle,A.keys=V.value.keys,A.channel=V.value.channel},handleClickTab:async e=>{var a;"response"===e.name?(y.value=!0,x.value=!0,d.value=!!(null==(a=c.value.project_config)?void 0:a.bind_extranet),K.value.includes(v.value)&&(d.value=!0),await J(),"python"!==v.value&&await O(),await W()):"error"===e.name&&G()},getErrorLogsEvent:G,onPathChange:()=>{s({type:"dir",path:q.value,change:e=>{q.value=e}})},saveLogPath:async()=>{E({confirm:{title:"保存日志路径",message:"是否保存日志路径["+q.value+"]",icon:"warning"},loading:"正在保存日志路径，请稍后...",request:async()=>await $({site_name:c.value.name,log_path:q.value}),async complete(){W(),f.value=!1}})},getTimes:e=>{let a=Number(e);return a=a<3?3:a,a},handleChangeTimeRefresh:async e=>{e?(o.value.timer=setInterval((()=>{W()}),1e3*o.value.time),H.value=setInterval((()=>{B.value--,0===B.value&&(B.value=Number(o.value.time)),m.value=B.value/Number(o.value.time)*100}),1e3)):(clearInterval(o.value.timer),clearInterval(H.value))},saveRefresh:async()=>{u.$message.success("保存成功"),B.value=Number(o.value.time),m.value=B.value/Number(o.value.time)*100,clearInterval(o.value.timer),clearInterval(H.value),o.value.timer=setInterval((()=>{W()}),1e3*o.value.time),H.value=setInterval((()=>{B.value--,0===B.value&&(B.value=Number(o.value.time)),m.value=B.value/Number(o.value.time)*100}),1e3)},specialData:K,checkBindExtranet:M,mountedEvent:Q,isRelease:a}}}),(function(){var e=this,a=e._self._c,t=e._self._setupProxy;return a("div",{staticClass:"h-full"},[t.isBindExtranet?a(b,{attrs:{type:"navtwo"},on:{"tab-click":t.handleClickTab},model:{value:t.tabActive,callback:function(e){t.tabActive=e},expression:"tabActive"}},[a(v,{staticClass:"overflow-hidden",attrs:{label:"响应日志",name:"response"}},["proxy"!==t.siteType&&"nginx"!==t.siteType?a("div",{staticClass:"flex items-center justify-between pt-16x"},[a("div",{directives:[{name:"loading",rawName:"v-loading",value:t.dataLoading,expression:"dataLoading"}],staticClass:"flex items-center"},["python"===t.siteType||t.isRelease?e._e():a(x,{on:{change:function(e){return t.setPushTaskEvent("switch")}},model:{value:t.responseLogData.alert,callback:function(a){e.$set(t.responseLogData,"alert",a)},expression:"responseLogData.alert"}}),"python"===t.siteType||t.isRelease?e._e():a("span",{staticClass:"ml-8x"},[e._v("关键字告警"),a(i,{on:{click:function(e){t.alertPopup=!0}}},[e._v("[配置]")])],1),a(r,{staticClass:"ml-12x",on:{change:t.changeIpShow},model:{value:t.responseLogData.showIp,callback:function(a){e.$set(t.responseLogData,"showIp",a)},expression:"responseLogData.showIp"}},[e._v("显示IP归属地信息 "),a(o,{staticClass:"ml-4x mt-2x",attrs:{name:"icon-ltd",size:"1.6"}})],1),a(n,{attrs:{placement:"bottom","popper-class":"white-tips-popover",width:"400",trigger:"click"},model:{value:t.pathPopover,callback:function(e){t.pathPopover=e},expression:"pathPopover"}},[a("div",{staticClass:"flex items-center p-12x"},[a(y,{attrs:{placeholder:"请输入日志路径","icon-type":"folder"},on:{folder:t.onPathChange},model:{value:t.logsPathValue,callback:function(e){t.logsPathValue=e},expression:"logsPathValue"}}),a(c,{staticClass:"!ml-8x",on:{click:t.saveLogPath}},[e._v("保存")])],1),"php"!==t.siteType||t.isRelease?e._e():a(c,{staticClass:"!ml-8x",attrs:{slot:"reference",type:"default"},slot:"reference"},[e._v("更改日志路径")])],1)],1),a("div",{staticClass:"flex items-center"},[a(c,{staticClass:"h-[3.6rem]",attrs:{type:"default"},on:{click:t.getLogs}},[a("div",{staticClass:"flex items-center"},[t.refreshData.status?a(p,{staticClass:"mr-8x",attrs:{width:18,"show-text":!0,"stroke-width":1,type:"circle",color:"#20a53a","text-color":"#20a53a",percentage:t.percentage,format:t.format}}):e._e(),a("span",[e._v("刷新日志")])],1)]),a(n,{attrs:{placement:"bottom",width:"240",trigger:"click","popper-class":"myPopover"}},[a("div",{staticClass:"flex flex-col text-[#666] p-12x"},[a("div",{staticClass:"flex items-center"},[a("span",{staticClass:"mr-4x"},[e._v("定时刷新")]),a(x,{on:{change:t.handleChangeTimeRefresh},model:{value:t.refreshData.status,callback:function(a){e.$set(t.refreshData,"status",a)},expression:"refreshData.status"}})],1),a("div",{directives:[{name:"show",rawName:"v-show",value:t.refreshData.status,expression:"refreshData.status"}],staticClass:"flex items-center mt-8x"},[a("span",{staticClass:"mr-4x"},[e._v("时间间隔")]),a(y,{attrs:{width:"10rem","text-type":"秒",type:"number"},model:{value:t.refreshData.time,callback:function(a){e.$set(t.refreshData,"time",a)},expression:"refreshData.time"}}),a(c,{staticClass:"!ml-8x",on:{click:t.saveRefresh}},[e._v("保存")])],1)]),a(c,{staticClass:"down-button !border-l-0 !ml-0",attrs:{slot:"reference",type:"default"},on:{click:function(e){t.visible=!t.visible}},slot:"reference"},[a("i",{staticClass:"el-icon-arrow-down"})])],1)],1)]):e._e(),"proxy"===t.siteType||"nginx"===t.siteType?a("div",{staticClass:"mt-[1.6rem]"},[e._v(" 日志大小："+e._s(t.responseLogData.size)+" ")]):e._e(),a(g,{directives:[{name:"loading",rawName:"v-loading",value:t.logLoading,expression:"logLoading"}],staticClass:"mt-16x",style:{height:"56rem",width:"99.5%"},attrs:{title:"全屏查看[响应]日志",content:t.responseLogData.logs,isHtml:!0,refresh:t.getLogs}}),a(u,{attrs:{title:"关键字告警配置",visible:t.alertPopup,area:58,showFooter:""},on:{confirm:function(e){return t.setPushTaskEvent("confirm")},cancel:t.cancelPopup,"update:visible":function(e){t.alertPopup=e}}},[a("div",{staticClass:"p-20x"},[a(d,{ref:"alertSetFormRef",attrs:{"label-position":"right",model:t.alertSetForm}},[a(h,{attrs:{label:"周期"}},[a(y,{attrs:{type:"number",min:1,"text-type":"分钟"},model:{value:t.alertSetForm.cycle,callback:function(a){e.$set(t.alertSetForm,"cycle",a)},expression:"alertSetForm.cycle"}})],1),a(h,{attrs:{label:"关键字"}},[a(y,{attrs:{type:"textarea",resize:"none",row:6},model:{value:t.alertSetForm.keys,callback:function(a){e.$set(t.alertSetForm,"keys",a)},expression:"alertSetForm.keys"}})],1),a(h,{attrs:{label:"告警方式"}},[a(f,{model:{value:t.alertSetForm.channel,callback:function(a){e.$set(t.alertSetForm,"channel",a)},expression:"alertSetForm.channel"}})],1)],1),a("ul",{staticClass:"mt-8x leading-8 text-[1.2rem] list-disc ml-20x"},[a("li",[e._v("检查时只检查间隔时间内的日志内容")]),a("li",[e._v("周期时间请勿设置太小，建议10分钟以上以免导致服务器资源异常")])])],1)])],1),a(v,{staticClass:"overflow-hidden",attrs:{label:"错误日志",name:"error",lazy:""}},["proxy"===t.siteType||"nginx"===t.siteType?a("div",{staticClass:"mt-[1.6rem]"},[e._v(" 日志大小："+e._s(t.responseLogData.size)+" ")]):e._e(),a("div",{staticClass:"flex"},[a(g,{directives:[{name:"loading",rawName:"v-loading",value:t.logLoading,expression:"logLoading"}],staticClass:"mt-16x",style:{height:"58rem",width:"99.5%"},attrs:{title:"全屏查看[错误]日志",content:t.errorLogData.logs,isHtml:!0,refresh:t.getErrorLogsEvent}})],1)]),"proxy"!==t.siteType&&"nginx"!==t.siteType?a(v,{attrs:{label:"日志安全分析",name:"safe",lazy:""}},[a(m,{attrs:{type:"site",name:e.compData.name}})],1):e._e()],1):a("div",{staticClass:"bg-[#7F7F7F] flex items-center justify-center h-full"},[a("div",{staticClass:"bg-white px-48x py-16x text-[#333]"},[e._v(" 请开启 "),a(i,{on:{click:t.jumpPath}},[e._v("外网映射")]),e._v(" 后查看配置信息 ")],1)])],1)}),[],!1,null,"4e90fe7f",null,null).exports;export{A as default};
