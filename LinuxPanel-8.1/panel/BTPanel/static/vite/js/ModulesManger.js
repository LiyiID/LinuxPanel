import{Q as e,n as a,q as t,a as s,b as l}from"./main.js?v=1714377894636";import{_ as o}from"./index39.js?v=1714377894636";import{_ as n}from"./index85.js?v=1714377894636";import{q as r,s as i}from"./element-lib.js?v=1714377894636";import{_ as m}from"./index59.js?v=1714377894636";import{e as p,b as c,h as u,i as d,j as _}from"./vue-lib.js?v=1714377894636";import{e as f}from"./index38.js?v=1714377894636";import{dV as g,dW as y,dX as v,dY as b,dZ as j}from"./site.store.js?v=1714377894636";import"./modulepreload-polyfill.js?v=1714377894636";import"./preload-helper.js?v=1714377894636";import"./request-lib.js?v=1714377894636";import"./__commonjsHelpers__.js?v=1714377894636";import"./locales-lib.js?v=1714377894636";import"./public-lib.js?v=1714377894636";import"./index45.js?v=1714377894636";import"./check.js?v=1714377894636";const h=a(p({__name:"ModulesManger",props:{compData:{default:{}}},setup(a){const t=a,{proxy:s}=_(),l=c(!1),o=c([{label:"模块名称",prop:"name"},{label:"版本",prop:"version"},{label:"协议",prop:"license"},{label:"描述",prop:"description"},f([{onClick:e=>{x(e,"update")},title:"更新"},{onClick:e=>{x(e,"uninstall")},title:"卸载"}])]),n=c([]),r=c(!1),i=c({mod_name:"",type:"yarn"}),m=c(),p=c("正在请求安装..."),h=async()=>{r.value=!0;try{const e=await b({data:JSON.stringify({project_name:t.compData.name,project_cwd:t.compData.project_cwd})});n.value=e.data}catch(e){}finally{r.value=!1}},x=async(e,a)=>{if(""!==i.value.mod_name||"install"!==a)try{"install"!=a&&await s.$confirm({width:50,title:"".concat("update"===a?"更新":"卸载","模块【").concat(e.name,"】"),message:"".concat("update"===a?"更新":"卸载","模块后，可能影响项目正常运行，请谨慎操作，是否继续操作？"),icon:"warning",type:"calc"});let l,o=s.$load("正在操作,请稍后...");l="install"===a?await g({data:JSON.stringify({project_name:t.compData.name,mod_name:i.value.mod_name,pkg_manager:i.value.type})}):"update"===a?await y({data:JSON.stringify({project_name:t.compData.name,mod_name:e.name,type:i.value.type})}):await v({data:JSON.stringify({project_name:t.compData.name,mod_name:e.name})}),l.data.status?(h(),s.$message.success(l.data.data),o.close()):(s.$message.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:l.data.error_msg,type:"error",duration:0,showClose:!0}),o.close())}catch(l){}else s.$message.error("请输入模块名称")};let w=null;const k=()=>{w=e({route:"/sock_shell",onMessage:S})},S=(e,a)=>{const t=a.data;p.value+="\n"+t,t.includes("Done")&&(l.value=!1,null==w||w.close(),p.value="正在请求安装...",s.$message.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:m.value.data.data,type:m.value.status?"success":"error"}))};return u((()=>{h()})),d((()=>{null==w||w.close()})),{__sfc:!0,props:t,vm:s,installPopup:l,tableColumns:o,tableData:n,tableLoading:r,modForm:i,resMsg:m,installMessage:p,getModules:h,handleOperation:x,useSocket:w,createWebSocket:k,onWSReceive:S,handleAllInstall:async()=>{try{const e=j({data:JSON.stringify({project_name:t.compData.name})});k(),null==w||w.send({"x-http-token":window.vite_public_request_token}),null==w||w.send("tail -f /www/server/panel/logs/npm-exec.log"),l.value=!0,m.value=await e;let{data:a}=await e;a.status||(s.$message.request({status:a.status,msg:a.data||a.msg}),null==w||w.close(),l.value=!1)}catch(e){}}}}}),(function(){var e=this,a=e._self._c,p=e._self._setupProxy;return a("div",[a(m,{scopedSlots:e._u([{key:"header-left",fn:function(){return[a("div",{staticClass:"flex items-center"},[a(r,{staticClass:"w-[10rem]",model:{value:p.modForm.type,callback:function(a){e.$set(p.modForm,"type",a)},expression:"modForm.type"}},[a(i,{attrs:{label:"yarn",value:"yarn"}}),a(i,{attrs:{label:"pnpm",value:"pnpm"}}),a(i,{attrs:{label:"npm",value:"npm"}})],1),a(n,{staticClass:"mx-8x",attrs:{placeholder:"模块名称"},model:{value:p.modForm.mod_name,callback:function(a){e.$set(p.modForm,"mod_name",a)},expression:"modForm.mod_name"}}),a(t,{on:{click:function(e){return p.handleOperation(null,"install")}}},[e._v("安装模块")])],1)]},proxy:!0},{key:"header-right",fn:function(){return[a(t,{on:{click:p.handleAllInstall}},[e._v("一键安装项目模块")])]},proxy:!0},{key:"content",fn:function(){return[a(o,{directives:[{name:"loading",rawName:"v-loading",value:p.tableLoading,expression:"tableLoading"}],attrs:{height:"680",column:p.tableColumns,data:p.tableData},scopedSlots:e._u([{key:"empty",fn:function(){return[a("div",[e._v("未安装模块,点击 "),a(s,{on:{click:p.handleAllInstall}},[e._v("一键安装项目模块")])],1)]},proxy:!0}])})]},proxy:!0},{key:"popup",fn:function(){return[a(l,{attrs:{title:"正在安装模块,请稍后...",visible:p.installPopup,area:[50,36]},on:{"update:visible":function(e){p.installPopup=e}}},[a("div",{staticClass:"bg-[#333] p-12x h-full text-white overflow-auto"},[a("pre",{domProps:{innerHTML:e._s(p.installMessage)}})])])]},proxy:!0}])})],1)}),[],!1,null,"f94a9c10",null,null).exports;export{h as default};
